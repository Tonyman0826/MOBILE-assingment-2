<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>主題清單</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <style>
      /* 使用 Ionic CSS 變數 */
      :root {
        --custom-primary: #3880ff;
        --custom-primary-light: #e8f2ff;
        --custom-success: #2dd36f;
        --custom-warning: #ffc409;
        --custom-danger: #eb445a;
        --custom-medium: #92949c;
      }

      /* 自定義卡片樣式 */
      .custom-card {
        --background: white;
        --border-radius: 12px;
        margin: 8px;
        border: 1px solid var(--ion-color-light-shade);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .custom-card:active {
        transform: scale(0.98);
        background: var(--custom-primary-light);
      }

      .search-header {
        --background: var(--custom-primary);
      }

      .category-badge {
        margin: 2px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .category-badge:active {
        transform: scale(0.95);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--custom-medium);
      }

      .empty-state ion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--custom-primary);
        opacity: 0.7;
      }

      .filter-status {
        background: linear-gradient(135deg, var(--custom-primary-light), white);
        border-bottom: 2px solid var(--custom-primary);
      }

      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: flex-end;
      }

      .favorite-icon {
        color: var(--custom-warning);
        margin-right: 8px;
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
        
        .tag-container {
          justify-content: flex-start;
          margin-top: 0.5rem;
        }
        
        .mobile-full-width {
          width: 100%;
        }
      }

      @media (min-width: 992px) {
        .custom-card {
          margin: 8px 16px;
        }
        
        .custom-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          border-color: var(--custom-primary);
        }
      }

      /* 動畫效果 */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      /* 載入狀態 */
      .skeleton-loader {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* 錯誤狀態 */
      .error-state {
        text-align: center;
        padding: 2rem;
        color: var(--custom-danger);
      }

      /* 初始化載入狀態 */
      .init-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- 初始化載入狀態 -->
      <div id="init-loading" class="init-loading">
        <ion-spinner name="crescent" style="width: 40px; height: 40px;"></ion-spinner>
        <p style="margin-top: 16px; color: var(--custom-medium);">應用程式載入中...</p>
      </div>

      <!-- 主頁面內容 (初始隱藏) -->
      <div id="main-content" style="display: none;">
        <ion-header class="search-header">
          <ion-toolbar>
            <ion-title>維基主題清單</ion-title>
            
            <ion-buttons slot="end">
              <ion-button id="theme-toggle" fill="clear">
                <ion-icon slot="icon-only" name="contrast"></ion-icon>
              </ion-button>
              <ion-button id="info-button" fill="clear">
                <ion-icon slot="icon-only" name="information-circle"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>

          <!-- 搜索區域 -->
          <ion-toolbar>
            <ion-searchbar 
              placeholder="搜尋主題..."
              animated="true"
              debounce="300"
              id="main-searchbar">
            </ion-searchbar>
          </ion-toolbar>

          <!-- 分類篩選 -->
          <ion-toolbar>
            <ion-segment value="all" id="category-segment">
              <ion-segment-button value="all">
                <ion-label>全部</ion-label>
              </ion-segment-button>
              <ion-segment-button value="education">
                <ion-label>教育</ion-label>
              </ion-segment-button>
              <ion-segment-button value="community">
                <ion-label>社群</ion-label>
              </ion-segment-button>
              <ion-segment-button value="tools">
                <ion-label>工具</ion-label>
              </ion-segment-button>
              <ion-segment-button value="favorites">
                <ion-label>收藏</ion-label>
              </ion-segment-button>
            </ion-segment>
          </ion-toolbar>
        </ion-header>

        <ion-content fullscreen="true">
          <!-- 篩選狀態顯示 -->
          <div id="filter-status" class="filter-status" style="display: none;"></div>

          <!-- 響應式佈局 -->
          <ion-grid fixed>
            <ion-row>
              <!-- 桌面端側邊欄 -->
              <ion-col size="12" size-md="3" class="desktop-only">
                <ion-list class="slide-in">
                  <ion-list-header>
                    <ion-label>快速篩選</ion-label>
                    <ion-button fill="clear" size="small" id="clear-filters">
                      <ion-icon name="refresh" slot="icon-only"></ion-icon>
                    </ion-button>
                  </ion-list-header>
                  
                  <ion-item button id="filter-all" color="primary">
                    <ion-icon name="apps" slot="start"></ion-icon>
                    <ion-label>全部主題</ion-label>
                    <ion-badge slot="end" color="primary" id="count-all">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-education">
                    <ion-icon name="school" slot="start"></ion-icon>
                    <ion-label>教育學習</ion-label>
                    <ion-badge slot="end" color="success" id="count-education">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-community">
                    <ion-icon name="people" slot="start"></ion-icon>
                    <ion-label>社群管理</ion-label>
                    <ion-badge slot="end" color="danger" id="count-community">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-tools">
                    <ion-icon name="construct" slot="start"></ion-icon>
                    <ion-label>工具資源</ion-label>
                    <ion-badge slot="end" color="warning" id="count-tools">0</ion-badge>
                  </ion-item>

                  <ion-item button id="filter-favorites">
                    <ion-icon name="star" slot="start"></ion-icon>
                    <ion-label>我的收藏</ion-label>
                    <ion-badge slot="end" color="warning" id="count-favorites">0</ion-badge>
                  </ion-item>
                </ion-list>

                <!-- 統計資訊 -->
                <ion-list class="slide-in" style="margin-top: 1rem;">
                  <ion-list-header>
                    <ion-label>統計資訊</ion-label>
                  </ion-list-header>
                  <ion-item>
                    <ion-label>總主題數</ion-label>
                    <ion-note slot="end" id="total-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>收藏數</ion-label>
                    <ion-note slot="end" id="favorite-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>分類數</ion-label>
                    <ion-note slot="end" id="category-count">0</ion-note>
                  </ion-item>
                </ion-list>
              </ion-col>

              <!-- 主要內容區域 -->
              <ion-col size="12" size-md="9">
                <!-- 下拉刷新 -->
                <ion-refresher slot="fixed" id="content-refresher">
                  <ion-refresher-content
                    pulling-icon="lines"
                    refreshing-spinner="crescent">
                  </ion-refresher-content>
                </ion-refresher>

                <!-- 載入狀態 -->
                <div id="loading-state" style="display: none;">
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                </div>

                <!-- 主題列表 -->
                <ion-list lines="full" id="theme-list">
                  <!-- 列表內容由 JavaScript 動態生成 -->
                </ion-list>

                <!-- 無限滾動 -->
                <ion-infinite-scroll id="infinite-scroll">
                  <ion-infinite-scroll-content
                    loading-spinner="bubbles"
                    loading-text="載入更多主題...">
                  </ion-infinite-scroll-content>
                </ion-infinite-scroll>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-content>

        <!-- 浮動操作按鈕 -->
        <ion-fab vertical="bottom" horizontal="end" slot="fixed">
          <ion-fab-button id="main-fab">
            <ion-icon name="ellipsis-vertical"></ion-icon>
          </ion-fab-button>
          <ion-fab-list side="top">
            <ion-fab-button color="secondary" id="fab-signup" data-action="signup">
              <ion-icon name="person-add"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="tertiary" id="fab-login" data-action="login">
              <ion-icon name="log-in"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="danger" id="fab-logout" data-action="logout" style="display: none;">
              <ion-icon name="log-out"></ion-icon>
            </ion-fab-button>
          </ion-fab-list>
        </ion-fab>

        <!-- 設定模態框 -->
        <ion-modal trigger="theme-toggle" id="settings-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>應用程式設定</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-list-header>
                <ion-label>外觀設定</ion-label>
              </ion-list-header>
              
              <ion-item>
                <ion-toggle id="dark-mode-toggle">
                  <ion-label>暗黑模式</ion-label>
                </ion-toggle>
              </ion-item>
              
              <ion-item>
                <ion-select label="主題色彩" id="theme-color-select">
                  <ion-select-option value="blue">藍色主題</ion-select-option>
                  <ion-select-option value="green">綠色主題</ion-select-option>
                  <ion-select-option value="purple">紫色主題</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <!-- 資訊模態框 -->
        <ion-modal trigger="info-button" id="info-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>關於應用程式</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-info-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-icon name="logo-ionic" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h3>維基主題清單</h3>
                  <p>版本 1.0.0</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label class="ion-text-wrap">
                  <h4>功能特色</h4>
                  <p>• 主題搜索與篩選</p>
                  <p>• 分類管理</p>
                  <p>• 收藏功能</p>
                  <p>• 響應式設計</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <!-- 註冊模態框 -->
        <ion-modal id="signup-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>用戶註冊</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-signup-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">用戶名</ion-label>
                <ion-input type="text" id="signup-username" placeholder="請輸入用戶名"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">密碼</ion-label>
                <ion-input type="password" id="signup-password" placeholder="請輸入密碼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-signup" style="margin-top: 20px;">
              註冊
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>已有帳號？ <a href="#" id="switch-to-login">立即登入</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>

        <!-- 登入模態框 -->
        <ion-modal id="login-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>用戶登入</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-login-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">用戶名</ion-label>
                <ion-input type="text" id="login-username" placeholder="請輸入用戶名"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">密碼</ion-label>
                <ion-input type="password" id="login-password" placeholder="請輸入密碼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-login" style="margin-top: 20px;">
              登入
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>還沒有帳號？ <a href="#" id="switch-to-signup">立即註冊</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>
      </div>

    <script>
      /**
       * 事件管理器 - 統一管理所有事件處理
       */
      class EventManager {
        constructor() {
          this.handlers = new Map();
          this.debounceTimers = new Map();
        }

        /**
         * 註冊事件監聽器
         */
        on(element, event, handler, options = {}) {
          if (!element) {
            console.warn('無法註冊事件: 元素為 null', event);
            return () => {};
          }
          
          if (!this.handlers.has(element)) {
            this.handlers.set(element, new Map());
          }
          
          const wrappedHandler = this.wrapHandler(handler, options);
          element.addEventListener(event, wrappedHandler, options);
          this.handlers.get(element).set(event, wrappedHandler);
          
          return () => this.off(element, event);
        }

        /**
         * 移除事件監聽器
         */
        off(element, event) {
          if (this.handlers.has(element)) {
            const handlers = this.handlers.get(element);
            if (handlers.has(event)) {
              element.removeEventListener(event, handlers.get(event));
              handlers.delete(event);
            }
          }
        }

        /**
         * 包裝處理器（支持防抖、節流）
         */
        wrapHandler(handler, options) {
          let wrappedHandler = handler;

          if (options.debounce) {
            wrappedHandler = this.debounce(handler, options.debounce);
          }

          if (options.throttle) {
            wrappedHandler = this.throttle(handler, options.throttle);
          }

          return wrappedHandler;
        }

        /**
         * 防抖函數
         */
        debounce(func, wait) {
          return (...args) => {
            const key = func.toString();
            clearTimeout(this.debounceTimers.get(key));
            this.debounceTimers.set(key, setTimeout(() => func(...args), wait));
          };
        }

        /**
         * 節流函數
         */
        throttle(func, limit) {
          let inThrottle;
          return (...args) => {
            if (!inThrottle) {
              func.apply(this, args);
              inThrottle = true;
              setTimeout(() => inThrottle = false, limit);
            }
          };
        }

        /**
         * 一次性事件
         */
        once(element, event, handler) {
          return this.on(element, event, handler, { once: true });
        }

        /**
         * 清理所有事件
         */
        destroy() {
          for (const [element, events] of this.handlers) {
            for (const [event, handler] of events) {
              element.removeEventListener(event, handler);
            }
          }
          this.handlers.clear();
          this.debounceTimers.clear();
        }
      }

      /**
       * DOM 操作管理器
       */
      class DOMManager {
        /**
         * 安全查詢元素
         */
        static query(selector, parent = document) {
          try {
            const element = parent.querySelector(selector);
            return element;
          } catch (error) {
            console.warn('DOM Query Error:', error.message);
            return null;
          }
        }

        /**
         * 安全查詢多個元素
         */
        static queryAll(selector, parent = document) {
          try {
            return Array.from(parent.querySelectorAll(selector));
          } catch (error) {
            console.warn('DOM QueryAll Error:', error.message);
            return [];
          }
        }

        /**
         * 創建元素
         */
        static create(tag, options = {}) {
          const element = document.createElement(tag);
          
          if (options.classes) {
            element.className = options.classes;
          }
          
          if (options.attributes) {
            Object.entries(options.attributes).forEach(([key, value]) => {
              element.setAttribute(key, value);
            });
          }
          
          if (options.properties) {
            Object.entries(options.properties).forEach(([key, value]) => {
              element[key] = value;
            });
          }
          
          if (options.html) {
            element.innerHTML = options.html;
          } else if (options.text) {
            element.textContent = options.text;
          }
          
          if (options.children) {
            options.children.forEach(child => {
              if (child instanceof Node) {
                element.appendChild(child);
              }
            });
          }
          
          return element;
        }

        /**
         * 顯示/隱藏元素
         */
        static toggleVisibility(selector, show) {
          const element = this.query(selector);
          if (element) {
            element.style.display = show ? '' : 'none';
          }
        }
      }

      /**
       * 資料管理器
       */
      class DataManager {
        constructor() {
          this.items = [];
          this.filters = {
            search: '',
            category: 'all',
            favorites: false
          };
          this.currentPage = 1;
          this.hasMore = true;
          this.isLoading = false;
          this.totalPages = 1;
          this.toastHandler = null;
        }

        /**
         * 設置 Toast 處理器
         */
        setToastHandler(handler) {
          this.toastHandler = handler;
        }

        /**
         * 顯示 Toast
         */
        showToast(message, color = 'primary') {
          if (this.toastHandler) {
            this.toastHandler(message, color);
          }
        }

        /**
         * 顯示/隱藏載入狀態
         */
        showLoading(show) {
          const loadingElement = document.getElementById('loading-state');
          const listElement = document.getElementById('theme-list');
          const infiniteScroll = document.getElementById('infinite-scroll');
          
          if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
          }
          if (listElement) {
            listElement.style.display = show ? 'none' : 'block';
          }
          if (infiniteScroll) {
            infiniteScroll.disabled = show;
          }
        }

        /**
         * 初始化資料
         */
        async initializeData() {
          try {
            console.log('🔍 測試API連線...');
            
            this.showLoading(true);
            
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/wiki-entries?page=1&limit=10');

            if (response.ok) {
              const data = await response.json();
              console.log('✅ API連線成功，收到資料:', data);
              
              this.items = data.items.map(item => ({
                id: item.id,
                title: item.title,
                subtitle: item.category,
                details: item.description,
                tags: item.tags || ['API資料'],
                category: this.mapCategory(item.category),
                favorite: false,
                apiData: true
              }));
              
              this.totalPages = data.pagination.total_pages || 1;
              this.currentPage = 1;
              this.hasMore = this.currentPage < this.totalPages;
              
              this.showToast('資料載入成功', 'success');
            } else {
              console.warn('❌ API連線失敗，狀態碼:', response.status);
              let errorMessage = `伺服器錯誤: ${response.status}`;
              try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                // 忽略 JSON 解析錯誤
              }
              this.showToast(`資料載入失敗: ${errorMessage}，使用本地範例資料`, 'warning');
              this.useFallbackData();
            }
            
            return this.items;
          } catch (error) {
            console.error('💥 API錯誤:', error);
            this.showToast('網路連線失敗，使用本地範例資料', 'warning');
            this.useFallbackData();
            return this.items;
          } finally {
            this.showLoading(false);
          }
        }

        /**
         * 載入更多資料
         */
        async loadMoreData() {
          if (this.isLoading || !this.hasMore) {
            return [];
          }

          try {
            this.isLoading = true;
            this.currentPage++;
            
            console.log(`📖 載入第 ${this.currentPage} 頁資料...`);
            
            const response = await fetch(`https://dae-mobile-assignment.hkit.cc/api/wiki-entries?page=${this.currentPage}&limit=10`);

            if (response.ok) {
              const data = await response.json();
              console.log('✅ 載入更多資料成功:', data);
              
              const newItems = data.items.map(item => ({
                id: item.id,
                title: item.title,
                subtitle: item.category,
                details: item.description,
                tags: item.tags || ['API資料'],
                category: this.mapCategory(item.category),
                favorite: false,
                apiData: true
              }));
              
              this.items = [...this.items, ...newItems];
              this.hasMore = this.currentPage < (data.pagination.total_pages || 1);
              
              if (newItems.length > 0) {
                this.showToast(`已載入 ${newItems.length} 個新主題`, 'success');
              } else {
                this.showToast('已載入所有主題', 'medium');
              }
              
              return newItems;
            } else {
              console.warn('❌ 載入更多資料失敗:', response.status);
              this.currentPage--; // 回退頁碼
              this.showToast('載入更多資料失敗', 'warning');
              return [];
            }
          } catch (error) {
            console.error('💥 載入更多資料錯誤:', error);
            this.currentPage--; // 回退頁碼
            this.showToast('載入更多資料時發生錯誤', 'danger');
            return [];
          } finally {
            this.isLoading = false;
          }
        }

        /**
         * 映射分類
         */
        mapCategory(category) {
          const categoryMap = {
            'education': 'education',
            'community': 'community', 
            'tools': 'tools',
            'technology': 'tools',
            'science': 'education',
            'culture': 'community'
          };
          return categoryMap[category] || 'education';
        }

        /**
         * 使用備用資料
         */
        useFallbackData() {
          this.items = [
            { 
              id: 1, 
              title: 'Wikipedia', 
              subtitle: '自由的網路百科全書', 
              details: '由全球志願者協作撰寫的多語言百科全書，包含超過數百萬篇條目，涵蓋各個領域的知識。', 
              tags: ['百科全書', '知識', '協作'], 
              category: 'education', 
              favorite: false,
              apiData: false
            },
            { 
              id: 2, 
              title: 'Wikimedia Foundation', 
              subtitle: '非營利組織', 
              details: '支援維基百科與其他維基專案的基金會，致力於讓知識自由分享給全世界。', 
              tags: ['組織', '非營利', '基金會'], 
              category: 'community', 
              favorite: true,
              apiData: false
            },
            { 
              id: 3, 
              title: 'MediaWiki', 
              subtitle: '維基軟體', 
              details: '維基百科使用的開源維基軟體，支援多人協作編輯和內容管理。', 
              tags: ['軟體', '開源', '編輯'], 
              category: 'tools', 
              favorite: false,
              apiData: false
            },
            { 
              id: 4, 
              title: 'Wikidata', 
              subtitle: '結構化資料庫', 
              details: '自由的結構化知識庫，為維基媒體項目提供機器可讀的資料。', 
              tags: ['資料庫', '結構化', '知識'], 
              category: 'tools', 
              favorite: false,
              apiData: false
            },
            { 
              id: 5, 
              title: 'Wiktionary', 
              subtitle: '線上詞典', 
              details: '自由的多語言詞典和詞庫，包含詞語定義、發音和用法示例。', 
              tags: ['詞典', '語言', '學習'], 
              category: 'education', 
              favorite: true,
              apiData: false
            }
          ];
          this.hasMore = false;
          console.log('📚 使用本地範例資料，共', this.items.length, '個項目');
        }

        /**
         * 過濾資料
         */
        filterItems() {
          return this.items.filter(item => {
            const matchesSearch = !this.filters.search || 
              item.title.toLowerCase().includes(this.filters.search) ||
              item.subtitle.toLowerCase().includes(this.filters.search) ||
              item.details.toLowerCase().includes(this.filters.search) ||
              item.tags.some(tag => tag.toLowerCase().includes(this.filters.search));
            
            const matchesCategory = this.filters.category === 'all' || 
              item.category === this.filters.category;
            
            const matchesFavorites = !this.filters.favorites || item.favorite;
            
            return matchesSearch && matchesCategory && matchesFavorites;
          });
        }

        /**
         * 更新篩選條件
         */
        updateFilters(newFilters) {
          this.filters = { ...this.filters, ...newFilters };
          return this.filterItems();
        }

        /**
         * 切換收藏狀態
         */
        async toggleFavorite(itemId, authService) {
          const item = this.items.find(item => item.id === itemId);
          if (!item) return false;

          const newFavoriteState = !item.favorite;
          
          // 如果用戶已登入且是 API 資料，則同步到後端
          if (authService.isLoggedIn() && item.apiData) {
            try {
              const response = await fetch(`https://dae-mobile-assignment.hkit.cc/api/wiki-entries/${itemId}/favorite`, {
                method: newFavoriteState ? 'POST' : 'DELETE',
                headers: {
                  'Authorization': `Bearer ${authService.token}`,
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                item.favorite = newFavoriteState;
                this.showToast(newFavoriteState ? '已加入收藏' : '已取消收藏', 'success');
                return newFavoriteState;
              } else {
                throw new Error('API 請求失敗');
              }
            } catch (error) {
              console.error('收藏操作失敗:', error);
              this.showToast('收藏操作失敗，請檢查網路連線', 'warning');
              return item.favorite; // 返回原狀態
            }
          } else {
            // 本地操作或未登入用戶
            item.favorite = newFavoriteState;
            if (authService.isLoggedIn()) {
              this.showToast(newFavoriteState ? '已加入收藏' : '已取消收藏', 'success');
            } else {
              this.showToast(newFavoriteState ? '已加入收藏（本地）' : '已取消收藏（本地）', 'medium');
            }
            return newFavoriteState;
          }
        }

        /**
         * 載入用戶收藏狀態
         */
        async loadUserFavorites(authService) {
          if (!authService.isLoggedIn()) return;

          try {
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/user/favorites', {
              headers: {
                'Authorization': `Bearer ${authService.token}`
              }
            });

            if (response.ok) {
              const favorites = await response.json();
              const favoriteIds = new Set(favorites.map(fav => fav.wiki_entry_id));
              
              // 更新本地收藏狀態
              this.items.forEach(item => {
                if (favoriteIds.has(item.id)) {
                  item.favorite = true;
                }
              });
              
              console.log('✅ 已同步用戶收藏狀態');
            }
          } catch (error) {
            console.warn('無法載入用戶收藏:', error);
          }
        }

        /**
         * 獲取統計資料
         */
        getStatistics() {
          const total = this.items.length;
          const favorites = this.items.filter(item => item.favorite).length;
          const categories = new Set(this.items.map(item => item.category)).size;
          
          const categoryCounts = {
            all: total,
            education: this.items.filter(item => item.category === 'education').length,
            community: this.items.filter(item => item.category === 'community').length,
            tools: this.items.filter(item => item.category === 'tools').length,
            favorites: favorites
          };

          return { total, favorites, categories, categoryCounts };
        }
      }

      /**
       * 認證服務
       */
      class AuthService {
        constructor() {
          this.baseURL = 'https://dae-mobile-assignment.hkit.cc/api';
          this.token = localStorage.getItem('auth_token');
          this.userId = localStorage.getItem('user_id');
        }

        /**
         * 用戶註冊
         */
        async signup(username, password) {
          try {
            console.log('🔐 開始註冊...');
            
            const response = await fetch(`${this.baseURL}/auth/signup`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `註冊失敗: ${response.status}`);
            }

            const data = await response.json();
            console.log('✅ 註冊成功:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('❌ 註冊錯誤:', error);
            throw error;
          }
        }

        /**
         * 用戶登入
         */
        async login(username, password) {
          try {
            console.log('🔐 開始登入...');
            
            const response = await fetch(`${this.baseURL}/auth/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `登入失敗: ${response.status}`);
            }

            const data = await response.json();
            console.log('✅ 登入成功:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('❌ 登入錯誤:', error);
            throw error;
          }
        }

        /**
         * 用戶登出
         */
        logout() {
          this.token = null;
          this.userId = null;
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_id');
          console.log('🚪 用戶已登出');
        }

        /**
         * 保存認證資料
         */
        saveAuthData(token, userId) {
          this.token = token;
          this.userId = userId;
          localStorage.setItem('auth_token', token);
          localStorage.setItem('user_id', userId);
          console.log('💾 認證資料已保存');
        }

        /**
         * 檢查是否已登入
         */
        isLoggedIn() {
          return !!this.token;
        }

        /**
         * 獲取認證標頭
         */
        getAuthHeaders() {
          return {
            'Authorization': `Bearer ${this.token}`
          };
        }
      }

      /**
       * Ionic 主題清單應用程式
       */
      class IonicThemeListApp {
        constructor() {
          this.eventManager = new EventManager();
          this.dataManager = new DataManager();
          this.authService = new AuthService();
          this.currentTheme = 'light';
          this.isLoading = false;
          this.isInitialized = false;
        }

        /**
         * 初始化應用程式
         */
        async initializeApp() {
          try {
            console.log('開始初始化應用程式...');
            
            DOMManager.toggleVisibility('#init-loading', true);
            DOMManager.toggleVisibility('#main-content', false);

            await this.waitForIonicComponents();
            
            // 設置 DataManager 的 toast 處理器
            this.dataManager.setToastHandler((message, color) => this.showToast(message, color));
            
            // 檢查登入狀態
            this.updateLoginState(this.authService.isLoggedIn());
            
            await this.dataManager.initializeData();
            
            // 如果用戶已登入，載入收藏狀態
            if (this.authService.isLoggedIn()) {
              await this.dataManager.loadUserFavorites(this.authService);
            }
            
            this.setupEventListeners();

            this.render();
            
            DOMManager.toggleVisibility('#init-loading', false);
            DOMManager.toggleVisibility('#main-content', true);
            
            this.isInitialized = true;
            console.log('應用程式初始化完成');
            
          } catch (error) {
            console.error('應用程式初始化失敗:', error);
            this.showErrorState('應用程式初始化失敗: ' + error.message);
          }
        }

        /**
         * 等待 Ionic 元件註冊完成
         */
        async waitForIonicComponents() {
          const components = [
            'ion-segment',
            'ion-searchbar', 
            'ion-refresher',
            'ion-infinite-scroll',
            'ion-list',
            'ion-modal',
            'ion-toast',
            'ion-action-sheet',
            'ion-loading'
          ];

          const promises = components.map(component => 
            customElements.whenDefined(component)
          );

          await Promise.all(promises);
          console.log('所有 Ionic 元件已註冊完成');
          
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        /**
         * 設置事件監聽器
         */
        setupEventListeners() {
          // 安全的元素查詢
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          const refresher = DOMManager.query('#content-refresher');
          const infiniteScroll = DOMManager.query('#infinite-scroll');

          if (searchbar) {
            this.eventManager.on(
              searchbar,
              'ionInput',
              (ev) => this.handleSearch(ev.detail.value),
              { debounce: 300 }
            );
          }

          if (segment) {
            this.eventManager.on(
              segment,
              'ionChange',
              (ev) => this.handleCategoryChange(ev.detail.value)
            );
          }

          if (refresher) {
            this.eventManager.on(
              refresher,
              'ionRefresh',
              (ev) => this.handleRefresh(ev)
            );
          }

          if (infiniteScroll) {
            this.eventManager.on(
              infiniteScroll,
              'ionInfinite',
              (ev) => this.handleInfiniteScroll(ev)
            );
          }

          // 註冊相關事件
          const signupButton = DOMManager.query('#submit-signup');
          if (signupButton) {
            this.eventManager.on(
              signupButton,
              'click',
              () => this.handleSignup()
            );
          }

          const closeSignupModal = DOMManager.query('#close-signup-modal');
          if (closeSignupModal) {
            this.eventManager.on(
              closeSignupModal,
              'click',
              () => this.closeSignupModal()
            );
          }

          const switchToLogin = DOMManager.query('#switch-to-login');
          if (switchToLogin) {
            this.eventManager.on(
              switchToLogin,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToLogin();
              }
            );
          }

          // 登入相關事件
          const loginButton = DOMManager.query('#submit-login');
          if (loginButton) {
            this.eventManager.on(
              loginButton,
              'click',
              () => this.handleLogin()
            );
          }

          const closeLoginModal = DOMManager.query('#close-login-modal');
          if (closeLoginModal) {
            this.eventManager.on(
              closeLoginModal,
              'click',
              () => this.closeLoginModal()
            );
          }

          const switchToSignup = DOMManager.query('#switch-to-signup');
          if (switchToSignup) {
            this.eventManager.on(
              switchToSignup,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToSignup();
              }
            );
          }

          // 快速篩選事件
          ['all', 'education', 'community', 'tools', 'favorites'].forEach(category => {
            const element = DOMManager.query(`#filter-${category}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleQuickFilter(category)
              );
            }
          });

          // FAB 動作事件
          ['signup', 'login', 'logout'].forEach(action => {
            const element = DOMManager.query(`#fab-${action}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleFabAction(action)
              );
            }
          });

          // 清除篩選事件
          const clearFilters = DOMManager.query('#clear-filters');
          if (clearFilters) {
            this.eventManager.on(
              clearFilters,
              'click',
              () => this.clearAllFilters()
            );
          }

          // 鍵盤事件
          this.eventManager.on(
            document,
            'keydown',
            (ev) => this.handleKeyboard(ev)
          );
        }

        /**
         * 處理搜索
         */
        handleSearch(searchTerm) {
          if (!this.isInitialized) return;
          
          const filteredItems = this.dataManager.updateFilters({ 
            search: searchTerm.toLowerCase() 
          });
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        /**
         * 處理分類變化
         */
        handleCategoryChange(category) {
          if (!this.isInitialized) return;
          
          const isFavorites = category === 'favorites';
          const filteredItems = this.dataManager.updateFilters({
            category: isFavorites ? 'all' : category,
            favorites: isFavorites
          });
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        /**
         * 處理快速篩選
         */
        handleQuickFilter(category) {
          const segment = DOMManager.query('#category-segment');
          if (segment) {
            segment.value = category;
          }
          this.handleCategoryChange(category);
        }

        /**
         * 處理下拉刷新
         */
        async handleRefresh(event) {
          this.dataManager.showLoading(true);
          
          try {
            await this.dataManager.initializeData();
            this.render();
            this.showToast('重新整理完成', 'success');
          } catch (error) {
            this.showToast('重新整理失敗', 'danger');
          } finally {
            this.dataManager.showLoading(false);
            if (event && event.target) {
              event.target.complete();
            }
          }
        }

        /**
         * 處理無限滾動
         */
        async handleInfiniteScroll(event) {
          try {
            const newItems = await this.dataManager.loadMoreData();
            if (newItems.length > 0) {
              this.renderFilteredItems(this.dataManager.filterItems());
            }
          } catch (error) {
            console.error('無限滾動錯誤:', error);
            this.showToast('載入更多資料失敗', 'danger');
          } finally {
            if (event && event.target) {
              event.target.complete();
              
              // 如果沒有更多資料，禁用無限滾動
              if (!this.dataManager.hasMore) {
                event.target.disabled = true;
              }
            }
          }
        }

        /**
         * 處理 FAB 動作
         */
        handleFabAction(action) {
          const actions = {
            signup: () => this.openSignupModal(),
            login: () => this.openLoginModal(),
            logout: () => this.handleLogout(),
            create: () => this.showToast('創建新主題功能', 'primary'),
            filter: () => this.showToast('進階篩選功能', 'primary'),
            sort: () => this.showSortOptions(),
            scrollTop: () => this.scrollToTop()
          };
          
          if (actions[action]) {
            actions[action]();
          } else {
            console.warn('未定義的 FAB 動作:', action);
          }
        }

        /**
         * 打開註冊模態框
         */
        openSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * 關閉註冊模態框
         */
        closeSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        /**
         * 處理用戶註冊
         */
        async handleSignup() {
          try {
            console.log('🟡 開始處理註冊...');
            
            const username = DOMManager.query('#signup-username').value;
            const password = DOMManager.query('#signup-password').value;
            
            console.log('📝 輸入的用戶名:', username);
            console.log('📝 輸入的密碼:', password);

            if (!username || !password) {
              this.showToast('請填寫用戶名和密碼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('用戶名至少需要3個字符', 'warning');
              return;
            }

            if (password.length < 6) {
              this.showToast('密碼至少需要6個字符', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            await this.authService.signup(username, password);
            
            this.showToast('註冊成功！', 'success');
            this.closeSignupModal();
            
            DOMManager.query('#signup-username').value = '';
            DOMManager.query('#signup-password').value = '';

            this.updateLoginState(true);

          } catch (error) {
            console.error('註冊處理錯誤:', error);
            this.showToast(`註冊失敗: ${error.message}`, 'danger');
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        /**
         * 處理用戶登入
         */
        async handleLogin() {
          try {
            console.log('🟡 開始處理登入...');
            
            const usernameInput = DOMManager.query('#login-username');
            const passwordInput = DOMManager.query('#login-password');
            
            if (!usernameInput || !passwordInput) {
              this.showToast('登入表單元素未找到', 'danger');
              return;
            }
            
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            console.log('📝 輸入的用戶名:', username);
            console.log('📝 輸入的密碼:', password);

            if (!username || !password) {
              this.showToast('請填寫用戶名和密碼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('用戶名至少需要3個字符', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            const result = await this.authService.login(username, password);
            
            // 載入用戶收藏狀態
            await this.dataManager.loadUserFavorites(this.authService);
            
            this.showToast('登入成功！', 'success');
            this.closeLoginModal();
            
            usernameInput.value = '';
            passwordInput.value = '';

            this.updateLoginState(true);
            this.render(); // 重新渲染以更新收藏狀態
            
            return result;

          } catch (error) {
            console.error('登入處理錯誤:', error);
            this.showToast(`登入失敗: ${error.message}`, 'danger');
            throw error;
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        /**
         * 打開登入模態框
         */
        openLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * 關閉登入模態框
         */
        closeLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        /**
         * 處理用戶登出
         */
        handleLogout() {
          this.authService.logout();
          this.showToast('已登出', 'medium');
          this.updateLoginState(false);
          this.render(); // 重新渲染以清除收藏狀態
        }

        /**
         * 切換到登入界面
         */
        switchToLogin() {
          this.closeSignupModal();
          this.openLoginModal();
        }

        /**
         * 切換到註冊界面
         */
        switchToSignup() {
          this.closeLoginModal();
          this.openSignupModal();
        }

        /**
         * 更新登入狀態 UI
         */
        updateLoginState(isLoggedIn) {
          const fabSignup = DOMManager.query('#fab-signup');
          const fabLogin = DOMManager.query('#fab-login');
          const fabLogout = DOMManager.query('#fab-logout');
          
          if (isLoggedIn) {
            if (fabSignup) fabSignup.style.display = 'none';
            if (fabLogin) fabLogin.style.display = 'none';
            if (fabLogout) fabLogout.style.display = 'block';
            console.log('✅ 用戶已登入，用戶ID:', this.authService.userId);
          } else {
            if (fabSignup) fabSignup.style.display = 'block';
            if (fabLogin) fabLogin.style.display = 'block';
            if (fabLogout) fabLogout.style.display = 'none';
            console.log('🚪 用戶未登入');
          }
        }

        /**
         * 處理鍵盤事件
         */
        handleKeyboard(event) {
          if (!this.isInitialized) return;
          
          switch (event.key) {
            case 'Escape':
              this.closeAllModals();
              break;
            case '/':
              if (!event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                const searchbar = DOMManager.query('#main-searchbar');
                if (searchbar) {
                  searchbar.setFocus();
                }
              }
              break;
          }
        }

        /**
         * 渲染過濾後的項目
         */
        renderFilteredItems(filteredItems) {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          if (filteredItems.length === 0) {
            this.showEmptyState();
            return;
          }

          list.innerHTML = '';
          filteredItems.forEach(item => {
            const listItem = this.createListItem(item);
            list.appendChild(listItem);
          });
        }

        /**
         * 創建列表項目
         */
        createListItem(item) {
          const ionItem = DOMManager.create('ion-item', {
            classes: 'custom-card fade-in',
            properties: {
              button: true,
              detail: true
            }
          });

          const grid = DOMManager.create('ion-grid');
          const row = DOMManager.create('ion-row');
          const colContent = DOMManager.create('ion-col', {
            attributes: {
              'size': '12',
              'size-md': '8'
            }
          });
          const colTags = DOMManager.create('ion-col', {
            attributes: {
              'size': '12', 
              'size-md': '4'
            }
          });

          const favoriteIcon = item.favorite ? 
            '<ion-icon name="star" class="favorite-icon"></ion-icon>' : '';
          
          colContent.innerHTML = `
            <ion-label>
              <h2 style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center;">
                ${favoriteIcon}${item.title}
              </h2>
              <p style="color: var(--ion-color-medium); margin-bottom: 8px;">${item.subtitle}</p>
              <p style="font-size: 0.9em; color: var(--ion-color-step-600); line-height: 1.4;">${item.details}</p>
            </ion-label>
          `;

          const tagsContainer = DOMManager.create('div', {
            classes: 'tag-container'
          });

          item.tags.forEach(tag => {
            const badge = DOMManager.create('ion-badge', {
              classes: 'category-badge',
              properties: {
                textContent: tag
              }
            });

            badge.color = this.getTagColor(tag);

            this.eventManager.on(badge, 'click', (e) => {
              e.stopPropagation();
              this.handleTagClick(tag);
            });

            tagsContainer.appendChild(badge);
          });

          colTags.appendChild(tagsContainer);

          row.appendChild(colContent);
          row.appendChild(colTags);
          grid.appendChild(row);
          ionItem.appendChild(grid);

          this.eventManager.on(ionItem, 'click', () => {
            this.showItemDetail(item);
          });

          return ionItem;
        }

        /**
         * 顯示項目詳情
         */
        async showItemDetail(item) {
          const actionSheet = DOMManager.create('ion-action-sheet');
          actionSheet.header = item.title;
          actionSheet.subHeader = item.subtitle;
          actionSheet.buttons = [
            {
              text: item.favorite ? '取消收藏' : '加入收藏',
              icon: item.favorite ? 'star-outline' : 'star',
              handler: () => this.toggleFavorite(item.id)
            },
            {
              text: '分享主題',
              icon: 'share', 
              handler: () => this.shareItem(item)
            },
            {
              text: '取消',
              icon: 'close',
              role: 'cancel'
            }
          ];

          document.body.appendChild(actionSheet);
          await actionSheet.present();
        }

        /**
         * 切換收藏狀態
         */
        async toggleFavorite(itemId) {
          try {
            const wasFavorite = await this.dataManager.toggleFavorite(itemId, this.authService);
            this.render();
            this.updateStatistics();
          } catch (error) {
            console.error('切換收藏失敗:', error);
          }
        }

        /**
         * 處理標籤點擊
         */
        handleTagClick(tag) {
          const searchbar = DOMManager.query('#main-searchbar');
          if (searchbar) {
            searchbar.value = tag;
          }
          this.handleSearch(tag);
          this.showToast(`已篩選標籤: ${tag}`);
        }

        /**
         * 顯示空狀態
         */
        showEmptyState() {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          list.innerHTML = `
            <div class="empty-state">
              <ion-icon name="search-outline"></ion-icon>
              <h3>沒有找到相關內容</h3>
              <p>請嘗試調整搜索條件或選擇其他分類</p>
              <ion-button fill="clear" onclick="app.clearAllFilters()">
                顯示所有主題
              </ion-button>
            </div>
          `;
        }

        /**
         * 顯示錯誤狀態
         */
        showErrorState(message) {
          const initLoading = DOMManager.query('#init-loading');
          if (initLoading) {
            initLoading.innerHTML = `
              <div class="error-state">
                <ion-icon name="warning" style="font-size: 3rem;"></ion-icon>
                <h3>載入失敗</h3>
                <p>${message}</p>
                <ion-button onclick="location.reload()">
                  重新載入
                </ion-button>
              </div>
            `;
          }
        }

        /**
         * 更新篩選狀態顯示
         */
        updateFilterStatus() {
          const statusElement = DOMManager.query('#filter-status');
          if (!statusElement) return;
          
          const filters = this.dataManager.filters;
          let statusText = '';

          if (filters.search) {
            statusText += `搜索: "${filters.search}" `;
          }
          if (filters.category !== 'all') {
            statusText += `分類: ${filters.category} `;
          }
          if (filters.favorites) {
            statusText += '僅收藏 ';
          }

          if (statusText) {
            statusElement.style.display = 'block';
            statusElement.innerHTML = `
              <ion-item>
                <ion-label>篩選條件: ${statusText}</ion-label>
                <ion-button fill="clear" size="small" onclick="app.clearAllFilters()">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-item>
            `;
          } else {
            statusElement.style.display = 'none';
          }
        }

        /**
         * 更新統計資訊
         */
        updateStatistics() {
          const stats = this.dataManager.getStatistics();
          
          const elements = [
            { id: 'total-count', value: stats.total },
            { id: 'favorite-count', value: stats.favorites },
            { id: 'category-count', value: stats.categories },
            { id: 'count-all', value: stats.categoryCounts.all },
            { id: 'count-education', value: stats.categoryCounts.education },
            { id: 'count-community', value: stats.categoryCounts.community },
            { id: 'count-tools', value: stats.categoryCounts.tools },
            { id: 'count-favorites', value: stats.categoryCounts.favorites }
          ];

          elements.forEach(({ id, value }) => {
            const element = DOMManager.query(`#${id}`);
            if (element) {
              element.textContent = value.toString();
            }
          });
        }

        /**
         * 清除所有篩選條件
         */
        clearAllFilters() {
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          
          if (searchbar) searchbar.value = '';
          if (segment) segment.value = 'all';
          
          this.dataManager.updateFilters({
            search: '',
            category: 'all', 
            favorites: false
          });
          this.render();
          
          const statusElement = DOMManager.query('#filter-status');
          if (statusElement) {
            statusElement.style.display = 'none';
          }
        }

        /**
         * 顯示/隱藏載入狀態
         */
        showLoading(show) {
          this.dataManager.showLoading(show);
        }

        /**
         * 滾動到頂部
         */
        scrollToTop() {
          const content = DOMManager.query('ion-content');
          if (content) {
            content.scrollToTop(500);
          }
        }

        /**
         * 關閉所有模態框
         */
        closeAllModals() {
          const modals = DOMManager.queryAll('ion-modal');
          modals.forEach(modal => {
            if (modal.dismiss) {
              modal.dismiss();
            }
          });
        }

        /**
         * 顯示排序選項
         */
        showSortOptions() {
          this.showToast('排序選項功能', 'primary');
        }

        /**
         * 分享項目
         */
        async shareItem(item) {
          if (navigator.share) {
            try {
              await navigator.share({
                title: item.title,
                text: item.details,
                url: window.location.href
              });
            } catch (error) {
              this.showToast('分享已取消', 'medium');
            }
          } else {
            this.showToast('分享功能不可用', 'warning');
          }
        }

        /**
         * 切換主題
         */
        toggleTheme(isDark) {
          this.currentTheme = isDark ? 'dark' : 'light';
          document.body.classList.toggle('ion-palette-dark', isDark);
          this.showToast(`已切換到${isDark ? '深色' : '淺色'}主題`);
        }

        /**
         * 獲取標籤顏色
         */
        getTagColor(tag) {
          const colorMap = {
            '教育': 'success', '詞典': 'success', '學習': 'success',
            '社群': 'danger', '組織': 'danger', '管理': 'danger', 
            '政策': 'warning', '結構': 'warning', '版本': 'warning',
            '媒體': 'tertiary', '資料': 'tertiary', '網站': 'tertiary',
            '百科': 'primary', '文獻': 'primary', '引用': 'primary',
            '工具': 'dark', '條目': 'secondary'
          };
          return colorMap[tag] || 'primary';
        }

        /**
         * 顯示 Ionic 吐司
         */
        async showToast(message, color = 'primary') {
          try {
            const toast = DOMManager.create('ion-toast', {
              properties: {
                message,
                duration: 2000,
                color,
                position: 'bottom'
              }
            });
            document.body.appendChild(toast);
            await toast.present();
          } catch (error) {
            console.warn('顯示 Toast 失敗:', error);
          }
        }

        /**
         * 主渲染函數
         */
        render() {
          const filteredItems = this.dataManager.filterItems();
          this.renderFilteredItems(filteredItems);
          this.updateStatistics();
          this.updateFilterStatus();
        }

        /**
         * 銷毀應用程式
         */
        destroy() {
          this.eventManager.destroy();
        }
      }

      // 全局應用程式實例
      let app;

      // 初始化應用程式
      document.addEventListener('DOMContentLoaded', async () => {
        app = new IonicThemeListApp();
        await app.initializeApp();
      });

      // 頁面卸載時清理
      window.addEventListener('beforeunload', () => {
        if (app) {
          app.destroy();
        }
      });
    </script>
  </body>
</html>
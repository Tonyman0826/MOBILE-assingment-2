<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>維基主題清單</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <style>
      /* 使用 Ionic CSS 變數 */
      :root {
        --custom-primary: #3880ff;
        --custom-primary-light: #e8f2ff;
        --custom-success: #2dd36f;
        --custom-warning: #ffc409;
        --custom-danger: #eb445a;
        --custom-medium: #92949c;
      }

      /* 自定義卡片 原有樣式保持不變
 */
      .custom-card {
        --background: white;
        --border-radius: 12px;
        margin: 8px;
        border: 1px solid var(--ion-color-light-shade);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .custom-card:active {
        transform: scale(0.98);
        background: var(--custom-primary-light);
      }

      .search-header {
        --background: var(--custom-primary);
      }

      .category-badge {
        margin: 2px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .category-badge:active {
        transform: scale(0.95);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--custom-medium);
      }

      .empty-state ion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--custom-primary);
        opacity: 0.7;
      }

      .filter-status {
        background: linear-gradient(135deg, var(--custom-primary-light), white);
        border-bottom: 2px solid var(--custom-primary);
      }

      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: flex-end;
      }

      .favorite-icon {
        color: var(--custom-warning);
        margin-right: 8px;
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
        
        .tag-container {
          justify-content: flex-start;
          margin-top: 0.5rem;
        }
        
        .mobile-full-width {
          width: 100%;
        }
      }

      @media (min-width: 992px) {
        .custom-card {
          margin: 8px 16px;
        }
        
        .custom-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          border-color: var(--custom-primary);
        }
      }

      /* 動畫效果 */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      /* 載入狀態 */
      .skeleton-loader {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* 錯誤狀態 - 确保样式可见 */
      .error-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--custom-danger);
        margin-top: 2rem;
      }

      .error-state ion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }

      .error-state ion-button {
        margin-top: 1.5rem;
        min-width: 180px;
      }

      /* 初始化載入狀態 - 确保占满屏幕可视区域 */
      .init-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80vh;
        flex-direction: column;
        width: 100%;
      }

      /* 加载更多提示样式 */
      .load-more-tip {
        text-align: center;
        padding: 1rem;
        color: var(--custom-medium);
      }

      /* 视频相关样式 */
      .video-container {
        margin-top: 12px;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }

      .video-thumbnail {
        width: 100%;
        height: auto;
        border-radius: 8px;
      }

      .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .play-button:hover {
        background-color: white;
        transform: translate(-50%, -50%) scale(1.1);
      }

      .video-info {
        display: flex;
        align-items: center;
        margin-top: 8px;
        color: var(--ion-color-medium);
        font-size: 0.9em;
      }

      .video-info ion-icon {
        margin-right: 6px;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- 初始化載入狀態 (API加载失败时显示错误提示) -->
      <div id="init-loading" class="init-loading">
        <ion-spinner name="crescent" style="width: 40px; height: 40px;"></ion-spinner>
        <p style="margin-top: 16px; color: var(--custom-medium);">正在請求 /api/wiki-entries 接口，獲取全部數據...</p>
      </div>

      <!-- 主頁面內容 (初始隱藏) -->
      <div id="main-content" style="display: none;">
        <!-- 原有HTML結構保持不變 -->
        <ion-header class="search-header">
          <ion-toolbar>
            <ion-title>維基主題清單</ion-title>
            
            <ion-buttons slot="end">
              <ion-button id="theme-toggle" fill="clear">
                <ion-icon slot="icon-only" name="contrast"></ion-icon>
              </ion-button>
              <ion-button id="info-button" fill="clear">
                <ion-icon slot="icon-only" name="information-circle"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>

          <!-- 搜索區域 -->
          <ion-toolbar>
            <ion-searchbar 
              placeholder="搜尋主題..."
              animated="true"
              debounce="300"
              id="main-searchbar">
            </ion-searchbar>
          </ion-toolbar>

          <!-- 分類篩選 -->
          <ion-toolbar>
            <ion-segment value="all" id="category-segment">
              <ion-segment-button value="all">
                <ion-label>全部</ion-label>
              </ion-segment-button>
              <ion-segment-button value="education">
                <ion-label>教育</ion-label>
              </ion-segment-button>
              <ion-segment-button value="community">
                <ion-label>社群</ion-label>
              </ion-segment-button>
              <ion-segment-button value="tools">
                <ion-label>工具</ion-label>
              </ion-segment-button>
              <ion-segment-button value="favorites">
                <ion-label>收藏</ion-label>
              </ion-segment-button>
            </ion-segment>
          </ion-toolbar>
        </ion-header>

        <ion-content fullscreen="true">
          <!-- 篩選狀態顯示 -->
          <div id="filter-status" class="filter-status" style="display: none;"></div>

          <!-- 響應式佈局 -->
          <ion-grid fixed>
            <ion-row>
              <!-- 桌面端側邊欄 -->
              <ion-col size="12" size-md="3" class="desktop-only">
                <ion-list class="slide-in">
                  <ion-list-header>
                    <ion-label>快速篩選</ion-label>
                    <ion-button fill="clear" size="small" id="clear-filters">
                      <ion-icon name="refresh" slot="icon-only"></ion-icon>
                    </ion-button>
                  </ion-list-header>
                  
                  <ion-item button id="filter-all" color="primary">
                    <ion-icon name="apps" slot="start"></ion-icon>
                    <ion-label>全部主題</ion-label>
                    <ion-badge slot="end" color="primary" id="count-all">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-education">
                    <ion-icon name="school" slot="start"></ion-icon>
                    <ion-label>教育學習</ion-label>
                    <ion-badge slot="end" color="success" id="count-education">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-community">
                    <ion-icon name="people" slot="start"></ion-icon>
                    <ion-label>社群管理</ion-label>
                    <ion-badge slot="end" color="danger" id="count-community">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-tools">
                    <ion-icon name="construct" slot="start"></ion-icon>
                    <ion-label>工具資源</ion-label>
                    <ion-badge slot="end" color="warning" id="count-tools">0</ion-badge>
                  </ion-item>

                  <ion-item button id="filter-favorites">
                    <ion-icon name="star" slot="start"></ion-icon>
                    <ion-label>我的收藏</ion-label>
                    <ion-badge slot="end" color="warning" id="count-favorites">0</ion-badge>
                  </ion-item>

                  <!-- 添加视频筛选选项 -->
                  <ion-item button id="filter-videos">
                    <ion-icon name="play" slot="start"></ion-icon>
                    <ion-label>含视频内容</ion-label>
                    <ion-badge slot="end" color="primary" id="count-videos">0</ion-badge>
                  </ion-item>
                </ion-list>

                <!-- 統計資訊 -->
                <ion-list class="slide-in" style="margin-top: 1rem;">
                  <ion-list-header>
                    <ion-label>統計資訊</ion-label>
                  </ion-list-header>
                  <ion-item>
                    <ion-label>總主題數</ion-label>
                    <ion-note slot="end" id="total-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>視頻資源數</ion-label>
                    <ion-note slot="end" id="video-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>收藏數</ion-label>
                    <ion-note slot="end" id="favorite-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>分類數</ion-label>
                    <ion-note slot="end" id="category-count">0</ion-note>
                  </ion-item>
                </ion-list>
              </ion-col>

              <!-- 主要內容區域 -->
              <ion-col size="12" size-md="9">
                <!-- 下拉刷新 -->
                <ion-refresher slot="fixed" id="content-refresher">
                  <ion-refresher-content
                    pulling-icon="lines"
                    refreshing-spinner="crescent"
                    pulling-text="下拉重新請求API數據...">
                  </ion-refresher-content>
                </ion-refresher>

                <!-- 載入狀態 -->
                <div id="loading-state" style="display: none;">
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                </div>

                <!-- 主題列表 -->
                <ion-list lines="full" id="theme-list">
                  <!-- 列表內容由 JavaScript 動態生成 -->
                </ion-list>

                <!-- 加載更多提示 -->
                <div id="load-more-tip" class="load-more-tip" style="display: none;">
                  <ion-spinner name="dots" style="width: 20px; height: 20px;"></ion-spinner>
                  <p>正在加載更多API數據...</p>
                </div>

                <!-- 加載完成提示 -->
                <div id="load-complete-tip" class="load-more-tip" style="display: none;">
                  <p>已加載全部API數據</p>
                </div>

                <!-- 無限滾動 -->
                <ion-infinite-scroll id="infinite-scroll">
                  <ion-infinite-scroll-content
                    loading-spinner="none"
                    loading-text="">
                  </ion-infinite-scroll-content>
                </ion-infinite-scroll>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-content>

        <!-- 浮動操作按鈕 -->
        <ion-fab vertical="bottom" horizontal="end" slot="fixed">
          <ion-fab-button id="main-fab">
            <ion-icon name="ellipsis-vertical"></ion-icon>
          </ion-fab-button>
          <ion-fab-list side="top">
            <ion-fab-button color="secondary" id="fab-signup" data-action="signup">
              <ion-icon name="person-add"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="tertiary" id="fab-login" data-action="login">
              <ion-icon name="log-in"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="danger" id="fab-logout" data-action="logout" style="display: none;">
              <ion-icon name="log-out"></ion-icon>
            </ion-fab-button>
            <!-- 重新加載API按鈕 -->
            <ion-fab-button color="primary" id="fab-reload" data-action="reload">
              <ion-icon name="refresh"></ion-icon>
            </ion-fab-button>
          </ion-fab-list>
        </ion-fab>

        <!-- 設定模態框 -->
        <ion-modal trigger="theme-toggle" id="settings-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>應用程式設定</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-list-header>
                <ion-label>外觀設定</ion-label>
              </ion-list-header>
              
              <ion-item>
                <ion-toggle id="dark-mode-toggle">
                  <ion-label>暗黑模式</ion-label>
                </ion-toggle>
              </ion-item>
              
              <ion-item>
                <ion-select label="主題色彩" id="theme-color-select">
                  <ion-select-option value="blue">藍色主題</ion-select-option>
                  <ion-select-option value="green">綠色主題</ion-select-option>
                  <ion-select-option value="purple">紫色主題</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <!-- 視頻播放模態框 -->
        <ion-modal id="video-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title id="video-modal-title">視頻播放</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-video-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <div id="video-player-container" style="position: relative; padding-bottom: 56.25%; height: 0;">
              <iframe id="video-player" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
            </div>
            <div id="video-description" class="ion-margin-top"></div>
          </ion-content>
        </ion-modal>

        <!-- 其他原有模態框保持不變 -->
        <!-- 資訊模態框 -->
        <ion-modal trigger="info-button" id="info-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>關於應用程式</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-info-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-icon name="logo-ionic" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h3>維基主題清單</h3>
                  <p>版本 1.0.0</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label class="ion-text-wrap">
                  <h4>功能特色</h4>
                  <p>• 顯示全部API中的維基主題</p>
                  <p>• 主題搜索與篩選</p>
                  <p>• 分類管理</p>
                  <p>• 收藏功能</p>
                  <p>• 視頻播放</p>
                  <p>• 響應式設計</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <!-- 註冊模態框 -->
        <ion-modal id="signup-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>用戶註冊</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-signup-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">用戶名</ion-label>
                <ion-input type="text" id="signup-username" placeholder="請輸入用戶名"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">密碼</ion-label>
                <ion-input type="password" id="signup-password" placeholder="請輸入密碼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-signup" style="margin-top: 20px;">
              註冊
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>已有帳號？ <a href="#" id="switch-to-login">立即登入</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>

        <!-- 登入模態框 -->
        <ion-modal id="login-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>用戶登入</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-login-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">用戶名</ion-label>
                <ion-input type="text" id="login-username" placeholder="請輸入用戶名"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">密碼</ion-label>
                <ion-input type="password" id="login-password" placeholder="請輸入密碼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-login" style="margin-top: 20px;">
              登入
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>還沒有帳號？ <a href="#" id="switch-to-signup">立即註冊</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>
      </div>

    <script>
      /**
       * 事件管理器 - 統一管理所有事件處理
       */
      class EventManager {
        constructor() {
          this.handlers = new Map();
          this.debounceTimers = new Map();
        }

        /**
         * 註冊事件監聽器
         */
        on(element, event, handler, options = {}) {
          if (!element) {
            console.warn('無法註冊事件: 元素為 null', event);
            return () => {};
          }
          
          if (!this.handlers.has(element)) {
            this.handlers.set(element, new Map());
          }
          
          const wrappedHandler = this.wrapHandler(handler, options);
          element.addEventListener(event, wrappedHandler, options);
          this.handlers.get(element).set(event, wrappedHandler);
          
          return () => this.off(element, event);
        }

        /**
         * 移除事件監聽器
         */
        off(element, event) {
          if (this.handlers.has(element)) {
            const handlers = this.handlers.get(element);
            if (handlers.has(event)) {
              element.removeEventListener(event, handlers.get(event));
              handlers.delete(event);
            }
          }
        }

        /**
         * 包裝處理器（支持防抖、節流）
         */
        wrapHandler(handler, options) {
          let wrappedHandler = handler;

          if (options.debounce) {
            wrappedHandler = this.debounce(handler, options.debounce);
          }

          if (options.throttle) {
            wrappedHandler = this.throttle(handler, options.throttle);
          }

          return wrappedHandler;
        }

        /**
         * 防抖函數
         */
        debounce(func, wait) {
          return (...args) => {
            const key = func.toString();
            clearTimeout(this.debounceTimers.get(key));
            this.debounceTimers.set(key, setTimeout(() => func(...args), wait));
          };
        }

        /**
         * 節流函數
         */
        throttle(func, limit) {
          let inThrottle;
          return (...args) => {
            if (!inThrottle) {
              func.apply(this, args);
              inThrottle = true;
              setTimeout(() => inThrottle = false, limit);
            }
          };
        }

        /**
         * 一次性事件
         */
        once(element, event, handler) {
          return this.on(element, event, handler, { once: true });
        }

        /**
         * 清理所有事件
         */
        destroy() {
          for (const [element, events] of this.handlers) {
            for (const [event, handler] of events) {
              element.removeEventListener(event, handler);
            }
          }
          this.handlers.clear();
          this.debounceTimers.clear();
        }
      }

      /**
       * DOM 操作管理器
       */
      class DOMManager {
        /**
         * 安全查詢元素
         */
        static query(selector, parent = document) {
          try {
            const element = parent.querySelector(selector);
            return element;
          } catch (error) {
            console.warn('DOM Query Error:', error.message);
            return null;
          }
        }

        /**
         * 安全查詢多個元素
         */
        static queryAll(selector, parent = document) {
          try {
            return Array.from(parent.querySelectorAll(selector));
          } catch (error) {
            console.warn('DOM QueryAll Error:', error.message);
            return [];
          }
        }

        /**
         * 創建元素
         */
        static create(tag, options = {}) {
          const element = document.createElement(tag);
          
          if (options.classes) {
            element.className = options.classes;
          }
          
          if (options.attributes) {
            Object.entries(options.attributes).forEach(([key, value]) => {
              element.setAttribute(key, value);
            });
          }
          
          if (options.properties) {
            Object.entries(options.properties).forEach(([key, value]) => {
              element[key] = value;
            });
          }
          
          if (options.html) {
            element.innerHTML = options.html;
          } else if (options.text) {
            element.textContent = options.text;
          }
          
          if (options.children) {
            options.children.forEach(child => {
              if (child instanceof Node) {
                element.appendChild(child);
              }
            });
          }
          
          return element;
        }

        /**
         * 顯示/隱藏元素
         */
        static toggleVisibility(selector, show) {
          const element = this.query(selector);
          if (element) {
            element.style.display = show ? '' : 'none';
          }
        }
      }

      /**
       * 資料管理器
       */
      class DataManager {
        constructor() {
          this.items = [];
          this.filters = {
            search: '',
            category: 'all',
            favorites: false,
            videos: false  // 新增视频筛选条件
          };
          this.currentPage = 1;
          this.hasMore = true;
          this.isLoading = false;
          this.totalPages = 1;
          this.totalItems = 0;
          this.toastHandler = null;
        }

        /**
         * 設置 Toast 處理器
         */
        setToastHandler(handler) {
          this.toastHandler = handler;
        }

        /**
         * 顯示 Toast
         */
        showToast(message, color = 'primary') {
          if (this.toastHandler) {
            this.toastHandler(message, color);
          }
        }

        /**
         * 顯示/隱藏載入狀態
         */
        showLoading(show) {
          const loadingElement = document.getElementById('loading-state');
          const listElement = document.getElementById('theme-list');
          const infiniteScroll = document.getElementById('infinite-scroll');
          const loadMoreTip = document.getElementById('load-more-tip');
          
          if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
          }
          if (listElement) {
            listElement.style.display = show ? 'none' : 'block';
          }
          if (infiniteScroll) {
            infiniteScroll.disabled = show;
          }
          if (loadMoreTip) {
            loadMoreTip.style.display = false;
          }
        }

        /**
         * 初始化資料 - 只從API加載
         */
        async initializeData() {
          try {
            console.log('🔍 請求 /api/wiki-entries 接口，獲取第1頁數據...');
            
            this.showLoading(true);
            
            // 先使用提供的测试数据，实际应用中替换为真实API
            // const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/wiki-entries?page=1&limit=10');
            
            // 模拟API响应，使用提供的测试数据
            const mockResponse = {
              "items": [
                {
                  "id": 80,
                  "tags": [
                    "生物多樣性",
                    "地球生態系統",
                    "多樣性",
                    "保育挑戰",
                    "永續發展策略",
                    "生態"
                  ],
                  "last_editor": "生態學家",
                  "last_edit_date": "2024-02-29",
                  "views": 19000,
                  "created_at": "2025-04-16 05:13:47",
                  "updated_at": "2025-05-04 08:14:53",
                  "title": "生物多樣性",
                  "description": "地球生態系統的多樣性、保育挑戰和永續發展策略。",
                  "category": "生態",
                  "image_url": "https://ikimono-museum.city.kyoto.lg.jp/wp/wp-content/themes/ikimono-museum/assets/img/page/02-01.png",
                  "video_url": "https://www.youtube.com/watch?v=RmJSyAikHJ4",
                  "published_at": "2024-03-01",
                  "languages": [
                    "繁體中文",
                    "簡體中文",
                    "英文",
                    "法文",
                    "西班牙文",
                    "葡萄牙文"
                  ],
                  "references": [
                    "生物多樣性公約",
                    "WWF研究報告",
                    "生態保育期刊",
                    "物種紅皮書"
                  ]
                },
                {
                  "id": 79,
                  "tags": [
                    "世界建築史",
                    "建築風格",
                    "流派",
                    "代表作品",
                    "建築",
                    "建築史"
                  ],
                  "last_editor": "建築史學者",
                  "last_edit_date": "2024-02-24",
                  "views": 16000,
                  "created_at": "2025-04-16 05:13:45",
                  "updated_at": "2025-05-04 08:14:53",
                  "title": "世界建築史",
                  "description": "從古代到現代的世界重要建築風格、流派和代表作品。",
                  "category": "建築",
                  "image_url": "https://onosekkei.net/wp/wp-content/uploads/2018/04/15351069877a5e761263bda3dfa2505a-1024x717.jpg",
                  "video_url": "https://www.youtube.com/watch?v=ReSffPAzvrA",
                  "published_at": "2024-02-25",
                  "languages": [
                    "繁體中文",
                    "簡體中文",
                    "英文",
                    "法文",
                    "義大利文",
                    "西班牙文"
                  ],
                  "references": [
                    "世界建築史料",
                    "建築理論文獻",
                    "現代建築評論",
                    "建築師傳記集"
                  ]
                },
                {
                  "id": 78,
                  "tags": [
                    "太空探索史",
                    "人類太空探索",
                    "重要里程碑",
                    "技術突破",
                    "未來展望",
                    "科學"
                  ],
                  "last_editor": "航太工程師",
                  "last_edit_date": "2024-02-19",
                  "views": 20000,
                  "created_at": "2025-04-16 05:13:43",
                  "updated_at": "2025-05-04 08:14:53",
                  "title": "太空探索史",
                  "description": "人類太空探索的重要里程碑、技術突破和未來展望。",
                  "category": "科學",
                  "image_url": "https://m.media-amazon.com/images/I/314NdmsAc6L._AC_UF1000,1000_QL80_.jpg",
                  "video_url": "https://www.youtube.com/watch?v=BrXqyhEqTQQ",
                  "published_at": "2024-02-20",
                  "languages": [
                    "繁體中文",
                    "簡體中文",
                    "英文",
                    "俄文",
                    "法文",
                    "德文"
                  ],
                  "references": [
                    "NASA檔案",
                    "太空總署報告",
                    "航太科技期刊",
                    "太空探索大事記"
                  ]
                }
              ],
              "pagination": {
                "page": 1,
                "limit": 3,
                "total": 10
              }
            };

            // 处理数据，映射到我们的应用模型
            this.items = mockResponse.items.map(item => ({
              id: item.id,
              title: item.title,
              subtitle: item.category,
              details: item.description,
              tags: item.tags || [],
              category: this.mapCategory(item.category),
              favorite: false,
              apiData: true,
              // 新增视频相关字段
              imageUrl: item.image_url,
              videoUrl: item.video_url,
              views: item.views,
              lastEditDate: item.last_edit_date,
              languages: item.languages || []
            }));
            
            this.totalPages = mockResponse.pagination.total_pages || 1;
            this.totalItems = mockResponse.pagination.total || 0;
            this.currentPage = 1;
            this.hasMore = this.currentPage < this.totalPages;
            
            this.showToast(`已加載 ${this.items.length}/${this.totalItems} 條API數據`, 'success');
            
            // 如果有多頁數據，嘗試加載更多
            if (this.hasMore) {
              this.showToast(`發現更多數據，共 ${this.totalPages} 頁`, 'primary');
            }
            
            return this.items;
          } catch (error) {
            console.error('💥 /api/wiki-entries 接口錯誤:', error);
            throw error; // 傳遞錯誤，讓上層處理
          } finally {
            this.showLoading(false);
          }
        }

        /**
         * 載入更多API資料
         */
        async loadMoreData() {
          if (this.isLoading || !this.hasMore) {
            return [];
          }

          try {
            this.isLoading = true;
            this.currentPage++;
            
            // 顯示加載更多提示
            DOMManager.toggleVisibility('#load-more-tip', true);
            DOMManager.toggleVisibility('#load-complete-tip', false);
            
            console.log(`📖 載入第 ${this.currentPage} 頁資料，共 ${this.totalPages} 頁`);
            
            // 模拟加载更多数据
            // 实际应用中替换为真实API请求
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 生成模拟数据
            const newItems = [];
            for (let i = 0; i < 3; i++) {
              const id = 77 - (this.currentPage - 1) * 3 - i;
              newItems.push({
                id: id,
                title: `模擬主題 ${id}`,
                subtitle: `分類 ${id % 3 === 0 ? '科學' : id % 3 === 1 ? '技術' : '文化'}`,
                details: `這是模擬的主題描述 ${id}，用於展示加載更多功能。`,
                tags: [`標籤 ${id}`, `範疇 ${id % 3 + 1}`],
                category: this.mapCategory(id % 3 === 0 ? '科學' : id % 3 === 1 ? '技術' : '文化'),
                favorite: false,
                apiData: true,
                imageUrl: `https://picsum.photos/seed/${id}/400/225`,
                videoUrl: id % 2 === 0 ? `https://www.youtube.com/watch?v=BrXqyhEqTQQ` : null,
                views: 1000 + id * 100,
                lastEditDate: "2024-02-19",
                languages: ["繁體中文", "簡體中文", "英文"]
              });
            }
            
            this.items = [...this.items, ...newItems];
            this.hasMore = this.currentPage < 3; // 限制最多3页，用于演示
            
            // 更新提示狀態
            if (!this.hasMore) {
              DOMManager.toggleVisibility('#load-more-tip', false);
              DOMManager.toggleVisibility('#load-complete-tip', true);
              this.showToast(`已加載全部 ${this.items.length} 條API數據`, 'success');
            } else {
              this.showToast(`已加載 ${this.items.length}/${this.totalItems} 條數據`, 'primary');
            }
            
            return newItems;
          } catch (error) {
            console.error('💥 載入更多資料錯誤:', error);
            this.currentPage--; // 回退頁碼
            this.showToast('加載更多API數據時發生錯誤', 'danger');
            return [];
          } finally {
            this.isLoading = false;
            if (!this.hasMore) {
              DOMManager.toggleVisibility('#load-more-tip', false);
            }
          }
        }

        /**
         * 映射分類
         */
        mapCategory(category) {
          const categoryMap = {
            'education': 'education',
            'community': 'community', 
            'tools': 'tools',
            'technology': 'tools',
            'science': 'education',
            '文化': 'community',
            '科學': 'education',
            '技術': 'tools',
            '生態': 'education',
            '建築': 'tools'
          };
          return categoryMap[category] || 'education';
        }

        /**
         * 過濾資料
         */
        filterItems() {
          return this.items.filter(item => {
            const matchesSearch = !this.filters.search || 
              item.title.toLowerCase().includes(this.filters.search) ||
              item.subtitle.toLowerCase().includes(this.filters.search) ||
              item.details.toLowerCase().includes(this.filters.search) ||
              item.tags.some(tag => tag.toLowerCase().includes(this.filters.search));
            
            const matchesCategory = this.filters.category === 'all' || 
              item.category === this.filters.category;
            
            const matchesFavorites = !this.filters.favorites || item.favorite;
            
            // 新增视频筛选条件
            const matchesVideos = !this.filters.videos || (item.videoUrl && item.videoUrl.trim() !== '');
            
            return matchesSearch && matchesCategory && matchesFavorites && matchesVideos;
          });
        }

        /**
         * 更新篩選條件
         */
        updateFilters(newFilters) {
          this.filters = { ...this.filters, ...newFilters };
          return this.filterItems();
        }

        /**
         * 切換收藏狀態
         */
        async toggleFavorite(itemId, authService) {
          const item = this.items.find(item => item.id === itemId);
          if (!item) return false;

          const newFavoriteState = !item.favorite;
          
          // 如果用戶已登入且是 API 資料，則同步到後端
          if (authService.isLoggedIn() && item.apiData) {
            try {
              const method = newFavoriteState ? 'POST' : 'DELETE';
              const url = `https://dae-mobile-assignment.hkit.cc/api/bookmarks/${itemId}`;
              
              const response = await fetch(url, {
                method: method,
                headers: {
                  'Authorization': `Bearer ${authService.token}`,
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                item.favorite = newFavoriteState;
                this.showToast(newFavoriteState ? '已加入收藏' : '已取消收藏', 'success');
                return newFavoriteState;
              } else {
                throw new Error('API 請求失敗');
              }
            } catch (error) {
              console.error('收藏操作失敗:', error);
              this.showToast('收藏操作失敗，請檢查網路連線', 'warning');
              return item.favorite; // 返回原狀態
            }
          } else {
            // 本地操作或未登入用戶
            item.favorite = newFavoriteState;
            if (authService.isLoggedIn()) {
              this.showToast(newFavoriteState ? '已加入收藏' : '已取消收藏', 'success');
            } else {
              this.showToast(newFavoriteState ? '已加入收藏（本地）' : '已取消收藏（本地）', 'medium');
            }
            return newFavoriteState;
          }
        }

        /**
         * 載入用戶收藏狀態
         */
        async loadUserFavorites(authService) {
          if (!authService.isLoggedIn()) return;

          try {
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/bookmarks', {
              headers: {
                'Authorization': `Bearer ${authService.token}`
              }
            });

            if (response.ok) {
              const favorites = await response.json();
              const favoriteIds = new Set(favorites.item_ids);
              
              // 更新本地收藏狀態
              this.items.forEach(item => {
                if (favoriteIds.has(item.id)) {
                  item.favorite = true;
                }
              });
              
              console.log('✅ 已同步用戶收藏狀態');
            }
          } catch (error) {
            console.warn('無法載入用戶收藏:', error);
          }
        }

        /**
         * 獲取統計資料
         */
        getStatistics() {
          const total = this.items.length;
          const favorites = this.items.filter(item => item.favorite).length;
          // 新增视频统计
          const videos = this.items.filter(item => item.videoUrl && item.videoUrl.trim() !== '').length;
          const categories = new Set(this.items.map(item => item.category)).size;
          
          const categoryCounts = {
            all: total,
            education: this.items.filter(item => item.category === 'education').length,
            community: this.items.filter(item => item.category === 'community').length,
            tools: this.items.filter(item => item.category === 'tools').length,
            favorites: favorites,
            videos: videos  // 视频数量统计
          };

          return { total, favorites, videos, categories, categoryCounts };
        }
      }

      /**
       * 認證服務
       */
      class AuthService {
        constructor() {
          this.baseURL = 'https://dae-mobile-assignment.hkit.cc/api';
          this.token = localStorage.getItem('auth_token');
          this.userId = localStorage.getItem('user_id');
        }

        /**
         * 用戶註冊
         */
        async signup(username, password) {
          try {
            console.log('🔐 開始註冊...');
            
            const response = await fetch(`${this.baseURL}/auth/signup`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `註冊失敗: ${response.status}`);
            }

            const data = await response.json();
            console.log('✅ 註冊成功:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('❌ 註冊錯誤:', error);
            throw error;
          }
        }

        /**
         * 用戶登入
         */
        async login(username, password) {
          try {
            console.log('🔐 開始登入...');
            
            const response = await fetch(`${this.baseURL}/auth/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `登入失敗: ${response.status}`);
            }

            const data = await response.json();
            console.log('✅ 登入成功:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('❌ 登入錯誤:', error);
            throw error;
          }
        }

        /**
         * 用戶登出
         */
        logout() {
          this.token = null;
          this.userId = null;
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_id');
          console.log('🚪 用戶已登出');
        }

        /**
         * 保存認證資料
         */
        saveAuthData(token, userId) {
          this.token = token;
          this.userId = userId;
          localStorage.setItem('auth_token', token);
          localStorage.setItem('user_id', userId);
          console.log('💾 認證資料已保存');
        }

        /**
         * 檢查是否已登入
         */
        isLoggedIn() {
          return !!this.token;
        }

        /**
         * 獲取認證標頭
         */
        getAuthHeaders() {
          return {
            'Authorization': `Bearer ${this.token}`
          };
        }
      }

      /**
       * Ionic 主題清單應用程式
       */
      class IonicThemeListApp {
        constructor() {
          this.eventManager = new EventManager();
          this.dataManager = new DataManager();
          this.authService = new AuthService();
          this.currentTheme = 'light';
          this.isLoading = false;
          this.isInitialized = false;
        }

        /**
         * 初始化應用程式
         */
        async initializeApp() {
          try {
            console.log('開始初始化應用程式...');
            
            DOMManager.toggleVisibility('#init-loading', true);
            DOMManager.toggleVisibility('#main-content', false);

            await this.waitForIonicComponents();
            
            // 設置 DataManager 的 toast 處理器
            this.dataManager.setToastHandler((message, color) => this.showToast(message, color));
            
            // 檢查登入狀態
            this.updateLoginState(this.authService.isLoggedIn());
            
            // 只從API初始化資料
            await this.dataManager.initializeData();
            
            // 如果用戶已登入，載入收藏狀態
            if (this.authService.isLoggedIn()) {
              await this.dataManager.loadUserFavorites(this.authService);
            }
            
            this.setupEventListeners();

            this.render();
            
            DOMManager.toggleVisibility('#init-loading', false);
            DOMManager.toggleVisibility('#main-content', true);
            
            this.isInitialized = true;
            console.log('應用程式初始化完成');
            
          } catch (error) {
            console.error('應用程式初始化失敗:', error);
            // API加載失敗時顯示錯誤狀態和重新加載按鈕
            this.showErrorState(`API請求失敗: ${error.message}`, true);
          }
        }

        /**
         * 等待 Ionic 元件註冊完成
         */
        async waitForIonicComponents() {
          const components = [
            'ion-segment',
            'ion-searchbar', 
            'ion-refresher',
            'ion-infinite-scroll',
            'ion-list',
            'ion-modal',
            'ion-toast',
            'ion-action-sheet',
            'ion-loading'
          ];

          const promises = components.map(component => 
            customElements.whenDefined(component)
          );

          await Promise.all(promises);
          console.log('所有 Ionic 元件已註冊完成');
          
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        /**
         * 設置事件監聽器
         */
        setupEventListeners() {
          // 安全的元素查詢
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          const refresher = DOMManager.query('#content-refresher');
          const infiniteScroll = DOMManager.query('#infinite-scroll');
          const reloadButton = DOMManager.query('#fab-reload');

          if (searchbar) {
            this.eventManager.on(
              searchbar,
              'ionInput',
              (ev) => this.handleSearch(ev.detail.value),
              { debounce: 300 }
            );
          }

          if (segment) {
            this.eventManager.on(
              segment,
              'ionChange',
              (ev) => this.handleCategoryChange(ev.detail.value)
            );
          }

          if (refresher) {
            this.eventManager.on(
              refresher,
              'ionRefresh',
              (ev) => this.handleRefresh(ev)
            );
          }

          if (infiniteScroll) {
            this.eventManager.on(
              infiniteScroll,
              'ionInfinite',
              (ev) => this.handleInfiniteScroll(ev)
            );
          }

          // 重新加載按鈕事件
          if (reloadButton) {
            this.eventManager.on(
              reloadButton,
              'click',
              () => this.reloadWikiEntries()
            );
          }

          // 註冊相關事件
          const signupButton = DOMManager.query('#submit-signup');
          if (signupButton) {
            this.eventManager.on(
              signupButton,
              'click',
              () => this.handleSignup()
            );
          }

          const closeSignupModal = DOMManager.query('#close-signup-modal');
          if (closeSignupModal) {
            this.eventManager.on(
              closeSignupModal,
              'click',
              () => this.closeSignupModal()
            );
          }

          const switchToLogin = DOMManager.query('#switch-to-login');
          if (switchToLogin) {
            this.eventManager.on(
              switchToLogin,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToLogin();
              }
            );
          }

          // 登入相關事件
          const loginButton = DOMManager.query('#submit-login');
          if (loginButton) {
            this.eventManager.on(
              loginButton,
              'click',
              () => this.handleLogin()
            );
          }

          const closeLoginModal = DOMManager.query('#close-login-modal');
          if (closeLoginModal) {
            this.eventManager.on(
              closeLoginModal,
              'click',
              () => this.closeLoginModal()
            );
          }

          const switchToSignup = DOMManager.query('#switch-to-signup');
          if (switchToSignup) {
            this.eventManager.on(
              switchToSignup,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToSignup();
              }
            );
          }

          // 快速篩選事件 - 新增视频筛选
          ['all', 'education', 'community', 'tools', 'favorites', 'videos'].forEach(category => {
            const element = DOMManager.query(`#filter-${category}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleQuickFilter(category)
              );
            }
          });

          // FAB 動作事件
          ['signup', 'login', 'logout', 'reload'].forEach(action => {
            const element = DOMManager.query(`#fab-${action}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleFabAction(action)
              );
            }
          });

          // 清除篩選事件
          const clearFilters = DOMManager.query('#clear-filters');
          if (clearFilters) {
            this.eventManager.on(
              clearFilters,
              'click',
              () => this.clearAllFilters()
            );
          }

          // 视频模态框关闭按钮
          const closeVideoModal = DOMManager.query('#close-video-modal');
          if (closeVideoModal) {
            this.eventManager.on(
              closeVideoModal,
              'click',
              () => this.closeVideoModal()
            );
          }

          // 鍵盤事件
          this.eventManager.on(
            document,
            'keydown',
            (ev) => this.handleKeyboard(ev)
          );
        }

        /**
         * 重新加載 Wiki Entries 接口數據
         */
        async reloadWikiEntries() {
          // 显示加载状态
          const initLoading = DOMManager.query('#init-loading');
          const mainContent = DOMManager.query('#main-content');
          
          // 如果是初始化后重新加载，先显示加载动画
          if (this.isInitialized) {
            this.dataManager.showLoading(true);
            this.showToast('正在重新请求 /api/wiki-entries 接口...', 'primary');
          } else {
            // 如果是初始化失败后重新加载，切换到加载状态
            if (initLoading) {
              initLoading.innerHTML = `
                <ion-spinner name="crescent" style="width: 40px; height: 40px;"></ion-spinner>
                <p style="margin-top: 16px; color: var(--custom-medium);">正在重新请求 /api/wiki-entries 接口...</p>
              `;
              initLoading.style.display = 'flex';
            }
            if (mainContent) mainContent.style.display = 'none';
          }

          try {
            // 重新初始化数据（请求 /api/wiki-entries 接口）
            await this.dataManager.initializeData();
            
            // 如果用户已登录，重新加载收藏状态
            if (this.authService.isLoggedIn()) {
              await this.dataManager.loadUserFavorites(this.authService);
            }
            
            // 重新渲染页面
            this.render();
            
            // 切换到主内容页面
            if (initLoading) initLoading.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            this.showToast('API數據重新加載成功！', 'success');
            this.isInitialized = true;
          } catch (error) {
            // 加载失败提示
            this.showErrorState(`重新请求失败：${error.message}`, true);
            this.showToast('重新加载失败，请检查网络后重试', 'danger');
          }
        }

        /**
         * 處理搜索
         */
        handleSearch(searchTerm) {
          if (!this.isInitialized) return;
          
          const filteredItems = this.dataManager.updateFilters({ 
            search: searchTerm.toLowerCase() 
          });
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        /**
         * 處理分類變化
         */
        handleCategoryChange(category) {
          if (!this.isInitialized) return;
          
          const isFavorites = category === 'favorites';
          const isVideos = category === 'videos';
          
          const filteredItems = this.dataManager.updateFilters({
            category: isFavorites || isVideos ? 'all' : category,
            favorites: isFavorites,
            videos: isVideos
          });
          
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        /**
         * 處理快速篩選
         */
        handleQuickFilter(category) {
          const segment = DOMManager.query('#category-segment');
          if (segment) {
            segment.value = category;
          }
          this.handleCategoryChange(category);
        }

        /**
         * 處理下拉刷新
         */
        async handleRefresh(event) {
          this.dataManager.showLoading(true);
          
          try {
            await this.dataManager.initializeData();
            this.render();
            this.showToast('API數據已更新', 'success');
          } catch (error) {
            this.showToast('刷新API數據失敗', 'danger');
          } finally {
            this.dataManager.showLoading(false);
            if (event && event.target) {
              event.target.complete();
            }
          }
        }

        /**
         * 處理無限滾動 - 加載更多API數據
         */
        async handleInfiniteScroll(event) {
          try {
            const newItems = await this.dataManager.loadMoreData();
            if (newItems.length > 0) {
              this.renderFilteredItems(this.dataManager.filterItems());
            }
          } catch (error) {
            console.error('無限滾動錯誤:', error);
            this.showToast('加載更多API數據失敗', 'danger');
          } finally {
            if (event && event.target) {
              event.target.complete();
              
              // 如果沒有更多資料，禁用無限滾動
              if (!this.dataManager.hasMore) {
                event.target.disabled = true;
              }
            }
          }
        }

        /**
         * 處理 FAB 動作
         */
        handleFabAction(action) {
          const actions = {
            signup: () => this.openSignupModal(),
            login: () => this.openLoginModal(),
            logout: () => this.handleLogout(),
            reload: () => this.reloadWikiEntries(),
            scrollTop: () => this.scrollToTop()
          };
          
          if (actions[action]) {
            actions[action]();
          } else {
            console.warn('未定義的 FAB 動作:', action);
          }
        }

        /**
         * 打開註冊模態框
         */
        openSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * 關閉註冊模態框
         */
        closeSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        /**
         * 處理用戶註冊
         */
        async handleSignup() {
          try {
            console.log('🟡 開始處理註冊...');
            
            const username = DOMManager.query('#signup-username').value;
            const password = DOMManager.query('#signup-password').value;
            
            if (!username || !password) {
              this.showToast('請填寫用戶名和密碼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('用戶名至少需要3個字符', 'warning');
              return;
            }

            if (password.length < 6) {
              this.showToast('密碼至少需要6個字符', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            await this.authService.signup(username, password);
            
            this.showToast('註冊成功！', 'success');
            this.closeSignupModal();
            
            DOMManager.query('#signup-username').value = '';
            DOMManager.query('#signup-password').value = '';

            this.updateLoginState(true);

          } catch (error) {
            console.error('註冊處理錯誤:', error);
            this.showToast(`註冊失敗: ${error.message}`, 'danger');
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        /**
         * 處理用戶登入
         */
        async handleLogin() {
          try {
            console.log('🟡 開始處理登入...');
            
            const usernameInput = DOMManager.query('#login-username');
            const passwordInput = DOMManager.query('#login-password');
            
            if (!usernameInput || !passwordInput) {
              this.showToast('登入表單元素未找到', 'danger');
              return;
            }
            
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            if (!username || !password) {
              this.showToast('請填寫用戶名和密碼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('用戶名至少需要3個字符', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            const result = await this.authService.login(username, password);
            
            // 載入用戶收藏狀態
            await this.dataManager.loadUserFavorites(this.authService);
            
            this.showToast('登入成功！', 'success');
            this.closeLoginModal();
            
            usernameInput.value = '';
            passwordInput.value = '';

            this.updateLoginState(true);
            this.render(); // 重新渲染以更新收藏狀態
            
            return result;

          } catch (error) {
            console.error('登入處理錯誤:', error);
            this.showToast(`登入失敗: ${error.message}`, 'danger');
            throw error;
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        /**
         * 打開登入模態框
         */
        openLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * 關閉登入模態框
         */
        closeLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        /**
         * 處理用戶登出
         */
        handleLogout() {
          this.authService.logout();
          this.showToast('已登出', 'medium');
          this.updateLoginState(false);
          this.render(); // 重新渲染以清除收藏狀態
        }

        /**
         * 切換到登入界面
         */
        switchToLogin() {
          this.closeSignupModal();
          this.openLoginModal();
        }

        /**
         * 切換到註冊界面
         */
        switchToSignup() {
          this.closeLoginModal();
          this.openSignupModal();
        }

        /**
         * 更新登入狀態 UI
         */
        updateLoginState(isLoggedIn) {
          const fabSignup = DOMManager.query('#fab-signup');
          const fabLogin = DOMManager.query('#fab-login');
          const fabLogout = DOMManager.query('#fab-logout');
          
          if (isLoggedIn) {
            if (fabSignup) fabSignup.style.display = 'none';
            if (fabLogin) fabLogin.style.display = 'none';
            if (fabLogout) fabLogout.style.display = 'block';
            console.log('✅ 用戶已登入，用戶ID:', this.authService.userId);
          } else {
            if (fabSignup) fabSignup.style.display = 'block';
            if (fabLogin) fabLogin.style.display = 'block';
            if (fabLogout) fabLogout.style.display = 'none';
            console.log('🚪 用戶未登入');
          }
        }

        /**
         * 處理鍵盤事件
         */
        handleKeyboard(event) {
          if (!this.isInitialized) return;
          
          switch (event.key) {
            case 'Escape':
              this.closeAllModals();
              break;
            case '/':
              if (!event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                const searchbar = DOMManager.query('#main-searchbar');
                if (searchbar) {
                  searchbar.setFocus();
                }
              }
              break;
          }
        }

        /**
         * 渲染過濾後的項目
         */
        renderFilteredItems(filteredItems) {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          if (filteredItems.length === 0) {
            this.showEmptyState();
            return;
          }

          // 保留现有元素的动画效果
          const currentItems = list.innerHTML;
          list.innerHTML = '';
          
          filteredItems.forEach(item => {
            const listItem = this.createListItem(item);
            list.appendChild(listItem);
          });
        }

        /**
         * 創建列表項目 - 添加视频展示
         */
        createListItem(item) {
          const ionItem = DOMManager.create('ion-item', {
            classes: 'custom-card fade-in',
            properties: {
              button: true,
              detail: true
            }
          });

          const grid = DOMManager.create('ion-grid');
          const row = DOMManager.create('ion-row');
          const colContent = DOMManager.create('ion-col', {
            attributes: {
              'size': '12'
            }
          });

          // 构建内容HTML，包含视频信息
          let contentHtml = `
            <ion-label>
              <h2 style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center;">
                ${item.favorite ? '<ion-icon name="star" class="favorite-icon"></ion-icon>' : ''}${item.title}
              </h2>
              <p style="color: var(--ion-color-medium); margin-bottom: 8px;">${item.subtitle}</p>
              <p style="font-size: 0.9em; color: var(--ion-color-step-600); line-height: 1.4;">${item.details}</p>
          `;
          
          // 如果有视频URL，添加视频缩略图和播放按钮
          if (item.videoUrl && item.videoUrl.trim() !== '') {
            // 从YouTube URL提取视频ID
            const videoId = this.extractVideoId(item.videoUrl);
            const thumbnailUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : item.imageUrl;
            
            contentHtml += `
              <div class="video-container" onclick="event.stopPropagation(); app.openVideoModal('${item.id}')">
                <img src="${thumbnailUrl}" class="video-thumbnail" alt="视频缩略图">
                <div class="play-button">
                  <ion-icon name="play" style="color: var(--custom-primary);"></ion-icon>
                </div>
              </div>
              <div class="video-info">
                <ion-icon name="play-circle"></ion-icon>
                <span>點擊觀看視頻</span>
              </div>
            `;
          } else if (item.imageUrl) {
            // 如果没有视频但有图片，显示图片
            contentHtml += `
              <div style="margin-top: 12px; border-radius: 8px; overflow: hidden;">
                <img src="${item.imageUrl}" style="width: 100%; height: auto; border-radius: 8px;" alt="${item.title}">
              </div>
            `;
          }
          
          // 添加标签容器
          contentHtml += `
              <div class="tag-container" style="margin-top: 8px;">
          `;
          
          item.tags.forEach(tag => {
            const color = this.getTagColor(tag);
            contentHtml += `
              <ion-badge class="category-badge" color="${color}" onclick="event.stopPropagation(); app.handleTagClick('${tag}')">
                ${tag}
              </ion-badge>
            `;
          });
          
          contentHtml += `
              </div>
            </ion-label>
          `;
          
          colContent.innerHTML = contentHtml;
          row.appendChild(colContent);
          grid.appendChild(row);
          ionItem.appendChild(grid);

          this.eventManager.on(ionItem, 'click', () => {
            this.showItemDetail(item);
          });

          return ionItem;
        }

        /**
         * 从YouTube URL中提取视频ID
         */
        extractVideoId(url) {
          if (!url) return null;
          
          // 处理各种YouTube URL格式
          const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
          const match = url.match(regExp);
          return (match && match[2].length === 11) ? match[2] : null;
        }

        /**
         * 打開視頻播放模態框
         */
        openVideoModal(itemId) {
          const item = this.dataManager.items.find(item => item.id == itemId);
          if (!item || !item.videoUrl) return;
          
          const videoId = this.extractVideoId(item.videoUrl);
          if (!videoId) {
            this.showToast('無法解析視頻URL', 'danger');
            return;
          }
          
          // 设置视频信息
          document.getElementById('video-modal-title').textContent = item.title;
          document.getElementById('video-player').src = `https://www.youtube.com/embed/${videoId}`;
          document.getElementById('video-description').textContent = item.description;
          
          // 显示视频模态框
          const modal = document.querySelector('ion-modal#video-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * 關閉視頻播放模態框
         */
        closeVideoModal() {
          const modal = document.querySelector('ion-modal#video-modal');
          if (modal) {
            // 停止视频播放
            const videoPlayer = document.getElementById('video-player');
            if (videoPlayer) {
              videoPlayer.src = '';
            }
            modal.dismiss();
          }
        }

        /**
         * 顯示項目詳情
         */
        async showItemDetail(item) {
          const actionSheet = DOMManager.create('ion-action-sheet');
          actionSheet.header = item.title;
          actionSheet.subHeader = item.subtitle;
          
          // 构建动作按钮，包含视频播放选项
          const buttons = [];
          
          // 如果有视频，添加播放视频按钮
          if (item.videoUrl && item.videoUrl.trim() !== '') {
            buttons.push({
              text: '播放視頻',
              icon: 'play',
              handler: () => this.openVideoModal(item.id)
            });
          }
          
          // 添加收藏按钮
          buttons.push({
            text: item.favorite ? '取消收藏' : '加入收藏',
            icon: item.favorite ? 'star-outline' : 'star',
            handler: () => this.toggleFavorite(item.id)
          });
          
          // 添加分享按钮
          buttons.push({
            text: '分享主題',
            icon: 'share', 
            handler: () => this.shareItem(item)
          });
          
          // 添加取消按钮
          buttons.push({
            text: '取消',
            icon: 'close',
            role: 'cancel'
          });
          
          actionSheet.buttons = buttons;

          document.body.appendChild(actionSheet);
          await actionSheet.present();
        }

        /**
         * 切換收藏狀態
         */
        async toggleFavorite(itemId) {
          try {
            const wasFavorite = await this.dataManager.toggleFavorite(itemId, this.authService);
            this.render();
            this.updateStatistics();
          } catch (error) {
            console.error('切換收藏失敗:', error);
          }
        }

        /**
         * 處理標籤點擊
         */
        handleTagClick(tag) {
          const searchbar = DOMManager.query('#main-searchbar');
          if (searchbar) {
            searchbar.value = tag;
          }
          this.handleSearch(tag);
          this.showToast(`已篩選標籤: ${tag}`);
        }

        /**
         * 顯示空狀態（包含重新加載按鈕）
         */
        showEmptyState() {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          list.innerHTML = `
            <div class="empty-state">
              <ion-icon name="search-outline"></ion-icon>
              <h3>沒有找到相關內容</h3>
              <p>請嘗試其他搜索條件或重新加載數據</p>
              <ion-button fill="solid" color="primary" onclick="app.reloadWikiEntries()">
                <ion-icon name="refresh" slot="start"></ion-icon>重新加載API數據
              </ion-button>
            </div>
          `;
        }

        /**
         * 顯示錯誤狀態（包含重新加載按鈕）
         * @param {string} message 錯誤信息
         * @param {boolean} isInitial 是否是初始化階段的錯誤
         */
        showErrorState(message, isInitial = false) {
          const targetElement = isInitial 
            ? DOMManager.query('#init-loading') 
            : DOMManager.query('#theme-list');
          
          if (!targetElement) return;
          
          targetElement.innerHTML = `
            <div class="error-state">
              <ion-icon name="warning"></ion-icon>
              <h3>無法加載 API 數據</h3>
              <p>${message}</p>
              <p>請點擊下方按鈕重新加載</p>
              <ion-button fill="solid" color="primary" onclick="app.reloadWikiEntries()">
                <ion-icon name="refresh" slot="start"></ion-icon>重新請求接口
              </ion-button>
            </div>
          `;
          
          // 如果是初始化錯誤，保持錯誤狀態可見
          if (isInitial) {
            targetElement.style.display = 'flex';
          }
        }

        /**
         * 更新篩選狀態顯示
         */
        updateFilterStatus() {
          const statusElement = DOMManager.query('#filter-status');
          if (!statusElement) return;
          
          const filters = this.dataManager.filters;
          let statusText = '';

          if (filters.search) {
            statusText += `搜索: "${filters.search}" `;
          }
          if (filters.category !== 'all') {
            statusText += `分類: ${filters.category} `;
          }
          if (filters.favorites) {
            statusText += '僅收藏 ';
          }
          if (filters.videos) {
            statusText += '僅視頻 ';
          }

          if (statusText) {
            statusElement.style.display = 'block';
            statusElement.innerHTML = `
              <ion-item>
                <ion-label>篩選條件: ${statusText}</ion-label>
                <ion-button fill="clear" size="small" onclick="app.clearAllFilters()">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-item>
            `;
          } else {
            statusElement.style.display = 'none';
          }
        }

        /**
         * 更新統計資訊 - 新增视频统计
         */
        updateStatistics() {
          const stats = this.dataManager.getStatistics();
          
          const elements = [
            { id: 'total-count', value: stats.total },
            { id: 'video-count', value: stats.videos },  // 视频数量
            { id: 'favorite-count', value: stats.favorites },
            { id: 'category-count', value: stats.categories },
            { id: 'count-all', value: stats.categoryCounts.all },
            { id: 'count-education', value: stats.categoryCounts.education },
            { id: 'count-community', value: stats.categoryCounts.community },
            { id: 'count-tools', value: stats.categoryCounts.tools },
            { id: 'count-favorites', value: stats.categoryCounts.favorites },
            { id: 'count-videos', value: stats.categoryCounts.videos }  // 视频筛选计数
          ];

          elements.forEach(({ id, value }) => {
            const element = DOMManager.query(`#${id}`);
            if (element) {
              element.textContent = value.toString();
            }
          });
        }

        /**
         * 清除所有篩選條件
         */
        clearAllFilters() {
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          
          if (searchbar) searchbar.value = '';
          if (segment) segment.value = 'all';
          
          this.dataManager.updateFilters({
            search: '',
            category: 'all', 
            favorites: false,
            videos: false  // 清除视频筛选
          });
          this.render();
          
          const statusElement = DOMManager.query('#filter-status');
          if (statusElement) {
            statusElement.style.display = 'none';
          }
        }

        /**
         * 顯示/隱藏載入狀態
         */
        showLoading(show) {
          this.dataManager.showLoading(show);
        }

        /**
         * 滾動到頂部
         */
        scrollToTop() {
          const content = DOMManager.query('ion-content');
          if (content) {
            content.scrollToTop(500);
          }
        }

        /**
         * 關閉所有模態框
         */
        closeAllModals() {
          const modals = DOMManager.queryAll('ion-modal');
          modals.forEach(modal => {
            if (modal.dismiss) {
              modal.dismiss();
            }
          });
        }

        /**
         * 顯示排序選項
         */
        showSortOptions() {
          this.showToast('排序選項功能', 'primary');
        }

        /**
         * 分享項目
         */
        async shareItem(item) {
          if (navigator.share) {
            try {
              await navigator.share({
                title: item.title,
                text: item.details,
                url: window.location.href
              });
            } catch (error) {
              this.showToast('分享已取消', 'medium');
            }
          } else {
            this.showToast('分享功能不可用', 'warning');
          }
        }

        /**
         * 切換主題
         */
        toggleTheme(isDark) {
          this.currentTheme = isDark ? 'dark' : 'light';
          document.body.classList.toggle('ion-palette-dark', isDark);
          this.showToast(`已切換到${isDark ? '深色' : '淺色'}主題`);
        }

        /**
         * 獲取標籤顏色
         */
        getTagColor(tag) {
          const colorMap = {
            '教育': 'success', '詞典': 'success', '學習': 'success',
            '社群': 'danger', '組織': 'danger', '管理': 'danger', 
            '政策': 'warning', '結構': 'warning', '版本': 'warning',
            '媒體': 'tertiary', '資料': 'tertiary', '網站': 'tertiary',
            '百科': 'primary', '文獻': 'primary', '引用': 'primary',
            '工具': 'dark', '條目': 'secondary',
            '生物多樣性': 'success', '地球生態系統': 'success',
            '世界建築史': 'tertiary', '建築風格': 'tertiary',
            '太空探索史': 'primary', '科學': 'primary'
          };
          return colorMap[tag] || 'primary';
        }

        /**
         * 顯示 Ionic 吐司
         */
        async showToast(message, color = 'primary') {
          try {
            const toast = DOMManager.create('ion-toast', {
              properties: {
                message,
                duration: 2000,
                color,
                position: 'bottom'
              }
            });
            document.body.appendChild(toast);
            await toast.present();
          } catch (error) {
            console.warn('顯示 Toast 失敗:', error);
          }
        }

        /**
         * 主渲染函數
         */
        render() {
          const filteredItems = this.dataManager.filterItems();
          this.renderFilteredItems(filteredItems);
          this.updateStatistics();
          this.updateFilterStatus();
          
          // 控制加載更多提示的顯示
          if (this.dataManager.items.length > 0) {
            DOMManager.toggleVisibility('#load-more-tip', this.dataManager.hasMore);
            DOMManager.toggleVisibility('#load-complete-tip', !this.dataManager.hasMore);
          }
        }

        /**
         * 銷毀應用程式
         */
        destroy() {
          this.eventManager.destroy();
        }
      }

      // 全局應用程式實例
      let app;

      // 初始化應用程式
      document.addEventListener('DOMContentLoaded', async () => {
        app = new IonicThemeListApp();
        await app.initializeApp();
      });

      // 頁面卸載時清理
      window.addEventListener('beforeunload', () => {
        if (app) {
          app.destroy();
        }
      });
    </script>
  </body>
</html>
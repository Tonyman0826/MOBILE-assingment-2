<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>维基主题清单</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <style>
      :root {
        --custom-primary: #3880ff;
        --custom-primary-light: #e8f2ff;
        --custom-success: #2dd36f;
        --custom-warning: #ffc409;
        --custom-danger: #eb445a;
        --custom-medium: #92949c;
      }

      .custom-card {
        --background: white;
        --border-radius: 12px;
        margin: 8px;
        border: 1px solid var(--ion-color-light-shade);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .custom-card:active {
        transform: scale(0.98);
        background: var(--custom-primary-light);
      }

      .search-header {
        --background: var(--custom-primary);
      }

      .category-badge {
        margin: 2px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .category-badge:active {
        transform: scale(0.95);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--custom-medium);
      }

      .empty-state ion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--custom-primary);
        opacity: 0.7;
      }

      .filter-status {
        background: linear-gradient(135deg, var(--custom-primary-light), white);
        border-bottom: 2px solid var(--custom-primary);
      }

      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: flex-end;
      }

      .favorite-icon {
        color: var(--custom-warning);
        margin-right: 8px;
      }

      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
        
        .tag-container {
          justify-content: flex-start;
          margin-top: 0.5rem;
        }
        
        .mobile-full-width {
          width: 100%;
        }
      }

      @media (min-width: 992px) {
        .custom-card {
          margin: 8px 16px;
        }
        
        .custom-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          border-color: var(--custom-primary);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      .skeleton-loader {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .error-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--custom-danger);
        margin-top: 2rem;
      }

      .error-state ion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }

      .error-state ion-button {
        margin-top: 1.5rem;
        min-width: 180px;
      }

      .init-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80vh;
        flex-direction: column;
        width: 100%;
      }

      .load-more-tip {
        text-align: center;
        padding: 1rem;
        color: var(--custom-medium);
      }

      .video-container {
        margin-top: 12px;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }

      .video-thumbnail {
        width: 100%;
        height: auto;
        border-radius: 8px;
      }

      .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .play-button:hover {
        background-color: white;
        transform: translate(-50%, -50%) scale(1.1);
      }

      .video-info {
        display: flex;
        align-items: center;
        margin-top: 8px;
        color: var(--ion-color-medium);
        font-size: 0.9em;
      }

      .video-info ion-icon {
        margin-right: 6px;
        font-size: 1.2em;
      }

      .retry-button {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- 初始化載入狀態 -->
      <div id="init-loading" class="init-loading">
        <ion-spinner name="crescent" style="width: 40px; height: 40px;"></ion-spinner>
        <p style="margin-top: 16px; color: var(--custom-medium);">正在請求 API 數據...</p>
      </div>

      <!-- API錯誤狀態 (初始隱藏) -->
      <div id="api-error-state" class="init-loading" style="display: none;">
        <ion-icon name="warning" style="font-size: 4rem; color: var(--custom-danger); margin-bottom: 1rem;"></ion-icon>
        <h3 style="color: var(--custom-danger);">無法連接到API服務器</h3>
        <p style="text-align: center; color: var(--custom-medium); margin: 1rem 0;">
          請檢查您的網絡連接，然後重試
        </p>
        <ion-button id="retry-api-button" color="primary" class="retry-button">
          <ion-icon name="refresh" slot="start"></ion-icon>
          重新嘗試連接
        </ion-button>
      </div>

      <!-- 主頁面內容 (初始隱藏) -->
      <div id="main-content" style="display: none;">
        <ion-header class="search-header">
          <ion-toolbar>
            <ion-title>维基主题清单</ion-title>
            
            <ion-buttons slot="end">
              <ion-button id="theme-toggle" fill="clear">
                <ion-icon slot="icon-only" name="contrast"></ion-icon>
              </ion-button>
              <ion-button id="info-button" fill="clear">
                <ion-icon slot="icon-only" name="information-circle"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>

          <ion-toolbar>
            <ion-searchbar 
              placeholder="搜尋主題..."
              animated="true"
              debounce="300"
              id="main-searchbar">
            </ion-searchbar>
          </ion-toolbar>

          <ion-toolbar>
            <ion-segment value="all" id="category-segment">
              <ion-segment-button value="all">
                <ion-label>全部</ion-label>
              </ion-segment-button>
              <ion-segment-button value="education">
                <ion-label>教育</ion-label>
              </ion-segment-button>
              <ion-segment-button value="community">
                <ion-label>社群</ion-label>
              </ion-segment-button>
              <ion-segment-button value="tools">
                <ion-label>工具</ion-label>
              </ion-segment-button>
              <ion-segment-button value="favorites">
                <ion-label>收藏</ion-label>
              </ion-segment-button>
              <ion-segment-button value="videos">
                <ion-label>视频</ion-label>
              </ion-segment-button>
            </ion-segment>
          </ion-toolbar>
        </ion-header>

        <ion-content fullscreen="true">
          <div id="filter-status" class="filter-status" style="display: none;"></div>

          <ion-grid fixed>
            <ion-row>
              <ion-col size="12" size-md="3" class="desktop-only">
                <ion-list class="slide-in">
                  <ion-list-header>
                    <ion-label>快速篩選</ion-label>
                    <ion-button fill="clear" size="small" id="clear-filters">
                      <ion-icon name="refresh" slot="icon-only"></ion-icon>
                    </ion-button>
                  </ion-list-header>
                  
                  <ion-item button id="filter-all" color="primary">
                    <ion-icon name="apps" slot="start"></ion-icon>
                    <ion-label>全部主題</ion-label>
                    <ion-badge slot="end" color="primary" id="count-all">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-education">
                    <ion-icon name="school" slot="start"></ion-icon>
                    <ion-label>教育學習</ion-label>
                    <ion-badge slot="end" color="success" id="count-education">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-community">
                    <ion-icon name="people" slot="start"></ion-icon>
                    <ion-label>社群管理</ion-label>
                    <ion-badge slot="end" color="danger" id="count-community">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-tools">
                    <ion-icon name="construct" slot="start"></ion-icon>
                    <ion-label>工具資源</ion-label>
                    <ion-badge slot="end" color="warning" id="count-tools">0</ion-badge>
                  </ion-item>

                  <ion-item button id="filter-favorites">
                    <ion-icon name="star" slot="start"></ion-icon>
                    <ion-label>我的收藏</ion-label>
                    <ion-badge slot="end" color="warning" id="count-favorites">0</ion-badge>
                  </ion-item>

                  <ion-item button id="filter-videos">
                    <ion-icon name="play" slot="start"></ion-icon>
                    <ion-label>含视频内容</ion-label>
                    <ion-badge slot="end" color="primary" id="count-videos">0</ion-badge>
                  </ion-item>
                </ion-list>

                <ion-list class="slide-in" style="margin-top: 1rem;">
                  <ion-list-header>
                    <ion-label>統計資訊</ion-label>
                  </ion-list-header>
                  <ion-item>
                    <ion-label>總主題數</ion-label>
                    <ion-note slot="end" id="total-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>視頻資源數</ion-label>
                    <ion-note slot="end" id="video-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>收藏數</ion-label>
                    <ion-note slot="end" id="favorite-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>分類數</ion-label>
                    <ion-note slot="end" id="category-count">0</ion-note>
                  </ion-item>
                </ion-list>
              </ion-col>

              <ion-col size="12" size-md="9">
                <ion-refresher slot="fixed" id="content-refresher">
                  <ion-refresher-content
                    pulling-icon="lines"
                    refreshing-spinner="crescent"
                    pulling-text="下拉重新請求API數據...">
                  </ion-refresher-content>
                </ion-refresher>

                <div id="loading-state" style="display: none;">
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                </div>

                <ion-list lines="full" id="theme-list">
                  <!-- 列表內容由 JavaScript 動態生成 -->
                </ion-list>

                <div id="load-more-tip" class="load-more-tip" style="display: none;">
                  <ion-spinner name="dots" style="width: 20px; height: 20px;"></ion-spinner>
                  <p>正在加載更多API數據...</p>
                </div>

                <div id="load-complete-tip" class="load-more-tip" style="display: none;">
                  <p>已加載全部API數據</p>
                </div>

                <ion-infinite-scroll id="infinite-scroll">
                  <ion-infinite-scroll-content
                    loading-spinner="none"
                    loading-text="">
                  </ion-infinite-scroll-content>
                </ion-infinite-scroll>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-content>

        <ion-fab vertical="bottom" horizontal="end" slot="fixed">
          <ion-fab-button id="main-fab">
            <ion-icon name="ellipsis-vertical"></ion-icon>
          </ion-fab-button>
          <ion-fab-list side="top">
            <ion-fab-button color="secondary" id="fab-signup" data-action="signup">
              <ion-icon name="person-add"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="tertiary" id="fab-login" data-action="login">
              <ion-icon name="log-in"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="danger" id="fab-logout" data-action="logout" style="display: none;">
              <ion-icon name="log-out"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="primary" id="fab-reload" data-action="reload">
              <ion-icon name="refresh"></ion-icon>
            </ion-fab-button>
          </ion-fab-list>
        </ion-fab>

        <ion-modal trigger="theme-toggle" id="settings-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>應用程式設定</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-list-header>
                <ion-label>外觀設定</ion-label>
              </ion-list-header>
              
              <ion-item>
                <ion-toggle id="dark-mode-toggle">
                  <ion-label>暗黑模式</ion-label>
                </ion-toggle>
              </ion-item>
              
              <ion-item>
                <ion-select label="主題色彩" id="theme-color-select">
                  <ion-select-option value="blue">藍色主題</ion-select-option>
                  <ion-select-option value="green">綠色主題</ion-select-option>
                  <ion-select-option value="purple">紫色主題</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <ion-modal id="video-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title id="video-modal-title">視頻播放</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-video-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <div id="video-player-container" style="position: relative; padding-bottom: 56.25%; height: 0;">
              <iframe id="video-player" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
            </div>
            <div id="video-description" class="ion-margin-top"></div>
          </ion-content>
        </ion-modal>

        <ion-modal trigger="info-button" id="info-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>關於應用程式</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-info-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-icon name="logo-ionic" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h3>维基主题清单</h3>
                  <p>版本 1.0.0</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label class="ion-text-wrap">
                  <h4>功能特色</h4>
                  <p>• 顯示全部API中的维基主题</p>
                  <p>• 主题搜索與篩選</p>
                  <p>• 分類管理</p>
                  <p>• 收藏功能</p>
                  <p>• 視頻播放</p>
                  <p>• 響應式設計</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <ion-modal id="signup-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>用戶註冊</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-signup-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">用戶名</ion-label>
                <ion-input type="text" id="signup-username" placeholder="請輸入用戶名"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">密碼</ion-label>
                <ion-input type="password" id="signup-password" placeholder="請輸入密碼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-signup" style="margin-top: 20px;">
              註冊
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>已有帳號？ <a href="#" id="switch-to-login">立即登入</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>

        <ion-modal id="login-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>用戶登入</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-login-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">用戶名</ion-label>
                <ion-input type="text" id="login-username" placeholder="請輸入用戶名"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">密碼</ion-label>
                <ion-input type="password" id="login-password" placeholder="請輸入密碼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-login" style="margin-top: 20px;">
              登入
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>還沒有帳號？ <a href="#" id="switch-to-signup">立即註冊</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>
      </div>

    <script>
      class EventManager {
        constructor() {
          this.handlers = new Map();
          this.debounceTimers = new Map();
        }

        on(element, event, handler, options = {}) {
          if (!element) {
            console.warn('無法註冊事件: 元素為 null', event);
            return () => {};
          }
          
          if (!this.handlers.has(element)) {
            this.handlers.set(element, new Map());
          }
          
          const wrappedHandler = this.wrapHandler(handler, options);
          element.addEventListener(event, wrappedHandler, options);
          this.handlers.get(element).set(event, wrappedHandler);
          
          return () => this.off(element, event);
        }

        off(element, event) {
          if (this.handlers.has(element)) {
            const handlers = this.handlers.get(element);
            if (handlers.has(event)) {
              element.removeEventListener(event, handlers.get(event));
              handlers.delete(event);
            }
          }
        }

        wrapHandler(handler, options) {
          let wrappedHandler = handler;

          if (options.debounce) {
            wrappedHandler = this.debounce(handler, options.debounce);
          }

          if (options.throttle) {
            wrappedHandler = this.throttle(handler, options.throttle);
          }

          return wrappedHandler;
        }

        debounce(func, wait) {
          return (...args) => {
            const key = func.toString();
            clearTimeout(this.debounceTimers.get(key));
            this.debounceTimers.set(key, setTimeout(() => func(...args), wait));
          };
        }

        throttle(func, limit) {
          let inThrottle;
          return (...args) => {
            if (!inThrottle) {
              func.apply(this, args);
              inThrottle = true;
              setTimeout(() => inThrottle = false, limit);
            }
          };
        }

        once(element, event, handler) {
          return this.on(element, event, handler, { once: true });
        }

        destroy() {
          for (const [element, events] of this.handlers) {
            for (const [event, handler] of events) {
              element.removeEventListener(event, handler);
            }
          }
          this.handlers.clear();
          this.debounceTimers.clear();
        }
      }

      class DOMManager {
        static query(selector, parent = document) {
          try {
            const element = parent.querySelector(selector);
            return element;
          } catch (error) {
            console.warn('DOM Query Error:', error.message);
            return null;
          }
        }

        static queryAll(selector, parent = document) {
          try {
            return Array.from(parent.querySelectorAll(selector));
          } catch (error) {
            console.warn('DOM QueryAll Error:', error.message);
            return [];
          }
        }

        static create(tag, options = {}) {
          const element = document.createElement(tag);
          
          if (options.classes) {
            element.className = options.classes;
          }
          
          if (options.attributes) {
            Object.entries(options.attributes).forEach(([key, value]) => {
              element.setAttribute(key, value);
            });
          }
          
          if (options.properties) {
            Object.entries(options.properties).forEach(([key, value]) => {
              element[key] = value;
            });
          }
          
          if (options.html) {
            element.innerHTML = options.html;
          } else if (options.text) {
            element.textContent = options.text;
          }
          
          if (options.children) {
            options.children.forEach(child => {
              if (child instanceof Node) {
                element.appendChild(child);
              }
            });
          }
          
          return element;
        }

        static toggleVisibility(selector, show) {
          const element = this.query(selector);
          if (element) {
            element.style.display = show ? '' : 'none';
          }
        }
      }

      class DataManager {
        constructor() {
          this.items = [];
          this.filters = {
            search: '',
            category: 'all',
            favorites: false,
            videos: false
          };
          this.currentPage = 1;
          this.hasMore = true;
          this.isLoading = false;
          this.totalPages = 1;
          this.totalItems = 0;
          this.toastHandler = null;
          this.apiBaseUrl = 'https://dae-mobile-assignment.hkit.cc/api';
          this.apiError = false;
        }

        setToastHandler(handler) {
          this.toastHandler = handler;
        }

        showToast(message, color = 'primary') {
          if (this.toastHandler) {
            this.toastHandler(message, color);
          }
        }

        showLoading(show) {
          const loadingElement = document.getElementById('loading-state');
          const listElement = document.getElementById('theme-list');
          const infiniteScroll = document.getElementById('infinite-scroll');
          const loadMoreTip = document.getElementById('load-more-tip');
          
          if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
          }
          if (listElement) {
            listElement.style.display = show ? 'none' : 'block';
          }
          if (infiniteScroll) {
            infiniteScroll.disabled = show;
          }
          if (loadMoreTip) {
            loadMoreTip.style.display = false;
          }
        }

        async initializeData() {
          try {
            console.log(`請求 ${this.apiBaseUrl}/wiki-entries 接口，獲取第1頁數據...`);
            
            this.showLoading(true);
            this.apiError = false;
            
            // 只从API获取数据，不使用任何模拟数据
            const response = await fetch(`${this.apiBaseUrl}/wiki-entries?page=1&limit=10`);
            
            if (!response.ok) {
              throw new Error(`API請求失敗: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // 处理API返回的数据
            this.items = data.items.map(item => ({
              id: item.id,
              title: item.title,
              subtitle: item.category,
              details: item.description,
              tags: item.tags || [],
              category: this.mapCategory(item.category),
              favorite: false,
              apiData: true,
              imageUrl: item.image_url,
              videoUrl: item.video_url,
              views: item.views,
              lastEditDate: item.last_edit_date,
              languages: item.languages || []
            }));
            
            this.totalPages = Math.ceil(data.pagination.total / data.pagination.limit);
            this.totalItems = data.pagination.total;
            this.currentPage = 1;
            this.hasMore = this.currentPage < this.totalPages;
            
            this.showToast(`已加載 ${this.items.length}/${this.totalItems} 條API數據`, 'success');
            
            return this.items;
          } catch (error) {
            console.error('API請求錯誤:', error);
            this.apiError = true;
            throw error; // 传递错误，让上层处理
          } finally {
            this.showLoading(false);
          }
        }

        async loadMoreData() {
          if (this.isLoading || !this.hasMore) {
            return [];
          }

          try {
            this.isLoading = true;
            this.currentPage++;
            
            DOMManager.toggleVisibility('#load-more-tip', true);
            DOMManager.toggleVisibility('#load-complete-tip', false);
            
            console.log(`載入第 ${this.currentPage} 頁資料，共 ${this.totalPages} 頁`);
            
            // 只从API加载更多数据
            const response = await fetch(`${this.apiBaseUrl}/wiki-entries?page=${this.currentPage}&limit=10`);
            
            if (!response.ok) {
              throw new Error(`加載更多失敗: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            const newItems = data.items.map(item => ({
              id: item.id,
              title: item.title,
              subtitle: item.category,
              details: item.description,
              tags: item.tags || [],
              category: this.mapCategory(item.category),
              favorite: false,
              apiData: true,
              imageUrl: item.image_url,
              videoUrl: item.video_url,
              views: item.views,
              lastEditDate: item.last_edit_date,
              languages: item.languages || []
            }));
            
            this.items = [...this.items, ...newItems];
            this.hasMore = this.currentPage < this.totalPages;
            
            if (!this.hasMore) {
              DOMManager.toggleVisibility('#load-more-tip', false);
              DOMManager.toggleVisibility('#load-complete-tip', true);
              this.showToast(`已加載全部 ${this.items.length} 條API數據`, 'success');
            } else {
              this.showToast(`已加載 ${this.items.length}/${this.totalItems} 條數據`, 'primary');
            }
            
            return newItems;
          } catch (error) {
            console.error('加載更多資料錯誤:', error);
            this.currentPage--; // 回退頁碼
            this.showToast('加載更多API數據時發生錯誤', 'danger');
            return [];
          } finally {
            this.isLoading = false;
            if (!this.hasMore) {
              DOMManager.toggleVisibility('#load-more-tip', false);
            }
          }
        }

        mapCategory(category) {
          const categoryMap = {
            'education': 'education',
            'community': 'community', 
            'tools': 'tools',
            'technology': 'tools',
            'science': 'education',
            '文化': 'community',
            '科學': 'education',
            '技術': 'tools',
            '生態': 'education',
            '建築': 'tools'
          };
          return categoryMap[category] || 'education';
        }

        filterItems() {
          return this.items.filter(item => {
            const matchesSearch = !this.filters.search || 
              item.title.toLowerCase().includes(this.filters.search) ||
              item.subtitle.toLowerCase().includes(this.filters.search) ||
              item.details.toLowerCase().includes(this.filters.search) ||
              item.tags.some(tag => tag.toLowerCase().includes(this.filters.search));
            
            const matchesCategory = this.filters.category === 'all' || 
              item.category === this.filters.category;
            
            const matchesFavorites = !this.filters.favorites || item.favorite;
            
            const matchesVideos = !this.filters.videos || (item.videoUrl && item.videoUrl.trim() !== '');
            
            return matchesSearch && matchesCategory && matchesFavorites && matchesVideos;
          });
        }

        updateFilters(newFilters) {
          this.filters = { ...this.filters, ...newFilters };
          return this.filterItems();
        }

        async toggleFavorite(itemId, authService) {
          const item = this.items.find(item => item.id === itemId);
          if (!item) return false;

          const newFavoriteState = !item.favorite;
          
          if (authService.isLoggedIn() && item.apiData) {
            try {
              const method = newFavoriteState ? 'POST' : 'DELETE';
              const url = `${this.apiBaseUrl}/bookmarks/${itemId}`;
              
              const response = await fetch(url, {
                method: method,
                headers: {
                  'Authorization': `Bearer ${authService.token}`,
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                item.favorite = newFavoriteState;
                this.showToast(newFavoriteState ? '已加入收藏' : '已取消收藏', 'success');
                return newFavoriteState;
              } else {
                throw new Error('API 請求失敗');
              }
            } catch (error) {
              console.error('收藏操作失敗:', error);
              this.showToast('收藏操作失敗，請檢查網路連線', 'warning');
              return item.favorite;
            }
          } else {
            item.favorite = newFavoriteState;
            if (authService.isLoggedIn()) {
              this.showToast(newFavoriteState ? '已加入收藏' : '已取消收藏', 'success');
            } else {
              this.showToast(newFavoriteState ? '已加入收藏（本地）' : '已取消收藏（本地）', 'medium');
            }
            return newFavoriteState;
          }
        }

        async loadUserFavorites(authService) {
          if (!authService.isLoggedIn()) return;

          try {
            const response = await fetch(`${this.apiBaseUrl}/bookmarks`, {
              headers: {
                'Authorization': `Bearer ${authService.token}`
              }
            });

            if (response.ok) {
              const favorites = await response.json();
              const favoriteIds = new Set(favorites.item_ids);
              
              this.items.forEach(item => {
                if (favoriteIds.has(item.id)) {
                  item.favorite = true;
                }
              });
              
              console.log('已同步用戶收藏狀態');
            }
          } catch (error) {
            console.warn('無法載入用戶收藏:', error);
          }
        }

        getStatistics() {
          const total = this.items.length;
          const favorites = this.items.filter(item => item.favorite).length;
          const videos = this.items.filter(item => item.videoUrl && item.videoUrl.trim() !== '').length;
          const categories = new Set(this.items.map(item => item.category)).size;
          
          const categoryCounts = {
            all: total,
            education: this.items.filter(item => item.category === 'education').length,
            community: this.items.filter(item => item.category === 'community').length,
            tools: this.items.filter(item => item.category === 'tools').length,
            favorites: favorites,
            videos: videos
          };

          return { total, favorites, videos, categories, categoryCounts };
        }
      }

      class AuthService {
        constructor() {
          this.baseURL = 'https://dae-mobile-assignment.hkit.cc/api';
          this.token = localStorage.getItem('auth_token');
          this.userId = localStorage.getItem('user_id');
        }

        async signup(username, password) {
          try {
            console.log('開始註冊...');
            
            const response = await fetch(`${this.baseURL}/auth/signup`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `註冊失敗: ${response.status}`);
            }

            const data = await response.json();
            console.log('註冊成功:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('註冊錯誤:', error);
            throw error;
          }
        }

        async login(username, password) {
          try {
            console.log('開始登入...');
            
            const response = await fetch(`${this.baseURL}/auth/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `登入失敗: ${response.status}`);
            }

            const data = await response.json();
            console.log('登入成功:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('登入錯誤:', error);
            throw error;
          }
        }

        logout() {
          this.token = null;
          this.userId = null;
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_id');
          console.log('用戶已登出');
        }

        saveAuthData(token, userId) {
          this.token = token;
          this.userId = userId;
          localStorage.setItem('auth_token', token);
          localStorage.setItem('user_id', userId);
          console.log('認證資料已保存');
        }

        isLoggedIn() {
          return !!this.token;
        }

        getAuthHeaders() {
          return {
            'Authorization': `Bearer ${this.token}`
          };
        }
      }

      class IonicThemeListApp {
        constructor() {
          this.eventManager = new EventManager();
          this.dataManager = new DataManager();
          this.authService = new AuthService();
          this.currentTheme = 'light';
          this.isLoading = false;
          this.isInitialized = false;
        }

        async initializeApp() {
          try {
            console.log('開始初始化應用程式...');
            
            DOMManager.toggleVisibility('#init-loading', true);
            DOMManager.toggleVisibility('#main-content', false);
            DOMManager.toggleVisibility('#api-error-state', false);

            await this.waitForIonicComponents();
            
            this.dataManager.setToastHandler((message, color) => this.showToast(message, color));
            
            this.updateLoginState(this.authService.isLoggedIn());
            
            // 只从API初始化数据
            await this.dataManager.initializeData();
            
            if (this.authService.isLoggedIn()) {
              await this.dataManager.loadUserFavorites(this.authService);
            }
            
            this.setupEventListeners();

            this.render();
            
            DOMManager.toggleVisibility('#init-loading', false);
            DOMManager.toggleVisibility('#main-content', true);
            
            this.isInitialized = true;
            console.log('應用程式初始化完成');
            
          } catch (error) {
            console.error('應用程式初始化失敗:', error);
            // API加载失败时显示错误状态和重新加载按钮
            this.showApiErrorState(`API請求失敗: ${error.message}`);
          }
        }

        async waitForIonicComponents() {
          const components = [
            'ion-segment',
            'ion-searchbar', 
            'ion-refresher',
            'ion-infinite-scroll',
            'ion-list',
            'ion-modal',
            'ion-toast',
            'ion-action-sheet',
            'ion-loading'
          ];

          const promises = components.map(component => 
            customElements.whenDefined(component)
          );

          await Promise.all(promises);
          console.log('所有 Ionic 元件已註冊完成');
          
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        setupEventListeners() {
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          const refresher = DOMManager.query('#content-refresher');
          const infiniteScroll = DOMManager.query('#infinite-scroll');
          const reloadButton = DOMManager.query('#fab-reload');
          const retryApiButton = DOMManager.query('#retry-api-button');

          if (searchbar) {
            this.eventManager.on(
              searchbar,
              'ionInput',
              (ev) => this.handleSearch(ev.detail.value),
              { debounce: 300 }
            );
          }

          if (segment) {
            this.eventManager.on(
              segment,
              'ionChange',
              (ev) => this.handleCategoryChange(ev.detail.value)
            );
          }

          if (refresher) {
            this.eventManager.on(
              refresher,
              'ionRefresh',
              (ev) => this.handleRefresh(ev)
            );
          }

          if (infiniteScroll) {
            this.eventManager.on(
              infiniteScroll,
              'ionInfinite',
              (ev) => this.handleInfiniteScroll(ev)
            );
          }

          if (reloadButton) {
            this.eventManager.on(
              reloadButton,
              'click',
              () => this.reloadWikiEntries()
            );
          }

          if (retryApiButton) {
            this.eventManager.on(
              retryApiButton,
              'click',
              () => this.reloadWikiEntries()
            );
          }

          const signupButton = DOMManager.query('#submit-signup');
          if (signupButton) {
            this.eventManager.on(
              signupButton,
              'click',
              () => this.handleSignup()
            );
          }

          const closeSignupModal = DOMManager.query('#close-signup-modal');
          if (closeSignupModal) {
            this.eventManager.on(
              closeSignupModal,
              'click',
              () => this.closeSignupModal()
            );
          }

          const switchToLogin = DOMManager.query('#switch-to-login');
          if (switchToLogin) {
            this.eventManager.on(
              switchToLogin,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToLogin();
              }
            );
          }

          const loginButton = DOMManager.query('#submit-login');
          if (loginButton) {
            this.eventManager.on(
              loginButton,
              'click',
              () => this.handleLogin()
            );
          }

          const closeLoginModal = DOMManager.query('#close-login-modal');
          if (closeLoginModal) {
            this.eventManager.on(
              closeLoginModal,
              'click',
              () => this.closeLoginModal()
            );
          }

          const switchToSignup = DOMManager.query('#switch-to-signup');
          if (switchToSignup) {
            this.eventManager.on(
              switchToSignup,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToSignup();
              }
            );
          }

          ['all', 'education', 'community', 'tools', 'favorites', 'videos'].forEach(category => {
            const element = DOMManager.query(`#filter-${category}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleQuickFilter(category)
              );
            }
          });

          ['signup', 'login', 'logout', 'reload'].forEach(action => {
            const element = DOMManager.query(`#fab-${action}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleFabAction(action)
              );
            }
          });

          const clearFilters = DOMManager.query('#clear-filters');
          if (clearFilters) {
            this.eventManager.on(
              clearFilters,
              'click',
              () => this.clearAllFilters()
            );
          }

          const closeVideoModal = DOMManager.query('#close-video-modal');
          if (closeVideoModal) {
            this.eventManager.on(
              closeVideoModal,
              'click',
              () => this.closeVideoModal()
            );
          }

          this.eventManager.on(
            document,
            'keydown',
            (ev) => this.handleKeyboard(ev)
          );
        }

        async reloadWikiEntries() {
          // 隐藏错误状态，显示加载状态
          DOMManager.toggleVisibility('#api-error-state', false);
          DOMManager.toggleVisibility('#init-loading', true);
          DOMManager.toggleVisibility('#main-content', false);

          try {
            await this.dataManager.initializeData();
            
            if (this.authService.isLoggedIn()) {
              await this.dataManager.loadUserFavorites(this.authService);
            }
            
            this.render();
            
            DOMManager.toggleVisibility('#init-loading', false);
            DOMManager.toggleVisibility('#main-content', true);
            
            this.showToast('API數據重新加載成功！', 'success');
            this.isInitialized = true;
          } catch (error) {
            this.showApiErrorState(`重新请求失败：${error.message}`);
            this.showToast('重新加载失败，请检查网络后重试', 'danger');
          }
        }

        showApiErrorState(message) {
          DOMManager.toggleVisibility('#init-loading', false);
          DOMManager.toggleVisibility('#main-content', false);
          DOMManager.toggleVisibility('#api-error-state', true);
          
          const errorState = DOMManager.query('#api-error-state');
          if (errorState) {
            errorState.innerHTML = `
              <ion-icon name="warning" style="font-size: 4rem; color: var(--custom-danger); margin-bottom: 1rem;"></ion-icon>
              <h3 style="color: var(--custom-danger);">無法連接到API服務器</h3>
              <p style="text-align: center; color: var(--custom-medium); margin: 1rem 0;">
                ${message}
              </p>
              <ion-button id="retry-api-button" color="primary" class="retry-button">
                <ion-icon name="refresh" slot="start"></ion-icon>
                重新嘗試連接
              </ion-button>
            `;
            
            // 重新绑定重试按钮事件
            const retryButton = DOMManager.query('#retry-api-button');
            if (retryButton) {
              this.eventManager.on(
                retryButton,
                'click',
                () => this.reloadWikiEntries()
              );
            }
          }
        }

        handleSearch(searchTerm) {
          if (!this.isInitialized) return;
          
          const filteredItems = this.dataManager.updateFilters({ 
            search: searchTerm.toLowerCase() 
          });
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        handleCategoryChange(category) {
          if (!this.isInitialized) return;
          
          const isFavorites = category === 'favorites';
          const isVideos = category === 'videos';
          
          const filteredItems = this.dataManager.updateFilters({
            category: isFavorites || isVideos ? 'all' : category,
            favorites: isFavorites,
            videos: isVideos
          });
          
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        handleQuickFilter(category) {
          const segment = DOMManager.query('#category-segment');
          if (segment) {
            segment.value = category;
          }
          this.handleCategoryChange(category);
        }

        async handleRefresh(event) {
          this.dataManager.showLoading(true);
          
          try {
            await this.dataManager.initializeData();
            this.render();
            this.showToast('API數據已更新', 'success');
          } catch (error) {
            this.showToast('刷新API數據失敗', 'danger');
          } finally {
            this.dataManager.showLoading(false);
            if (event && event.target) {
              event.target.complete();
            }
          }
        }

        async handleInfiniteScroll(event) {
          try {
            const newItems = await this.dataManager.loadMoreData();
            if (newItems.length > 0) {
              this.renderFilteredItems(this.dataManager.filterItems());
            }
          } catch (error) {
            console.error('無限滾動錯誤:', error);
            this.showToast('加載更多API數據失敗', 'danger');
          } finally {
            if (event && event.target) {
              event.target.complete();
              
              if (!this.dataManager.hasMore) {
                event.target.disabled = true;
              }
            }
          }
        }

        handleFabAction(action) {
          const actions = {
            signup: () => this.openSignupModal(),
            login: () => this.openLoginModal(),
            logout: () => this.handleLogout(),
            reload: () => this.reloadWikiEntries(),
            scrollTop: () => this.scrollToTop()
          };
          
          if (actions[action]) {
            actions[action]();
          } else {
            console.warn('未定義的 FAB 動作:', action);
          }
        }

        openSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.present();
          }
        }

        closeSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        async handleSignup() {
          try {
            const username = DOMManager.query('#signup-username').value;
            const password = DOMManager.query('#signup-password').value;
            
            if (!username || !password) {
              this.showToast('請填寫用戶名和密碼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('用戶名至少需要3個字符', 'warning');
              return;
            }

            if (password.length < 6) {
              this.showToast('密碼至少需要6個字符', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            await this.authService.signup(username, password);
            
            this.showToast('註冊成功！', 'success');
            this.closeSignupModal();
            
            DOMManager.query('#signup-username').value = '';
            DOMManager.query('#signup-password').value = '';

            this.updateLoginState(true);

          } catch (error) {
            console.error('註冊處理錯誤:', error);
            this.showToast(`註冊失敗: ${error.message}`, 'danger');
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        async handleLogin() {
          try {
            const usernameInput = DOMManager.query('#login-username');
            const passwordInput = DOMManager.query('#login-password');
            
            if (!usernameInput || !passwordInput) {
              this.showToast('登入表單元素未找到', 'danger');
              return;
            }
            
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            if (!username || !password) {
              this.showToast('請填寫用戶名和密碼', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            const result = await this.authService.login(username, password);
            
            await this.dataManager.loadUserFavorites(this.authService);
            
            this.showToast('登入成功！', 'success');
            this.closeLoginModal();
            
            usernameInput.value = '';
            passwordInput.value = '';

            this.updateLoginState(true);
            this.render();
            
            return result;

          } catch (error) {
            console.error('登入處理錯誤:', error);
            this.showToast(`登入失敗: ${error.message}`, 'danger');
            throw error;
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        openLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.present();
          }
        }

        closeLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        handleLogout() {
          this.authService.logout();
          this.showToast('已登出', 'medium');
          this.updateLoginState(false);
          this.render();
        }

        switchToLogin() {
          this.closeSignupModal();
          this.openLoginModal();
        }

        switchToSignup() {
          this.closeLoginModal();
          this.openSignupModal();
        }

        updateLoginState(isLoggedIn) {
          const fabSignup = DOMManager.query('#fab-signup');
          const fabLogin = DOMManager.query('#fab-login');
          const fabLogout = DOMManager.query('#fab-logout');
          
          if (isLoggedIn) {
            if (fabSignup) fabSignup.style.display = 'none';
            if (fabLogin) fabLogin.style.display = 'none';
            if (fabLogout) fabLogout.style.display = 'block';
          } else {
            if (fabSignup) fabSignup.style.display = 'block';
            if (fabLogin) fabLogin.style.display = 'block';
            if (fabLogout) fabLogout.style.display = 'none';
          }
        }

        handleKeyboard(event) {
          if (!this.isInitialized) return;
          
          switch (event.key) {
            case 'Escape':
              this.closeAllModals();
              break;
            case '/':
              if (!event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                const searchbar = DOMManager.query('#main-searchbar');
                if (searchbar) {
                  searchbar.setFocus();
                }
              }
              break;
          }
        }

        renderFilteredItems(filteredItems) {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          if (filteredItems.length === 0) {
            this.showEmptyState();
            return;
          }

          list.innerHTML = '';
          
          filteredItems.forEach(item => {
            const listItem = this.createListItem(item);
            list.appendChild(listItem);
          });
        }

        createListItem(item) {
          const ionItem = DOMManager.create('ion-item', {
            classes: 'custom-card fade-in',
            properties: {
              button: true,
              detail: true
            }
          });

          const grid = DOMManager.create('ion-grid');
          const row = DOMManager.create('ion-row');
          const colContent = DOMManager.create('ion-col', {
            attributes: {
              'size': '12'
            }
          });

          let contentHtml = `
            <ion-label>
              <h2 style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center;">
                ${item.favorite ? '<ion-icon name="star" class="favorite-icon"></ion-icon>' : ''}${item.title}
              </h2>
              <p style="color: var(--ion-color-medium); margin-bottom: 8px;">${item.subtitle}</p>
              <p style="font-size: 0.9em; color: var(--ion-color-step-600); line-height: 1.4;">${item.details}</p>
          `;
          
          if (item.videoUrl && item.videoUrl.trim() !== '') {
            const videoId = this.extractVideoId(item.videoUrl);
            const thumbnailUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : item.imageUrl;
            
            contentHtml += `
              <div class="video-container" onclick="event.stopPropagation(); app.openVideoModal('${item.id}')">
                <img src="${thumbnailUrl}" class="video-thumbnail" alt="视频缩略图">
                <div class="play-button">
                  <ion-icon name="play" style="color: var(--custom-primary);"></ion-icon>
                </div>
              </div>
              <div class="video-info">
                <ion-icon name="play-circle"></ion-icon>
                <span>點擊觀看視頻</span>
              </div>
            `;
          } else if (item.imageUrl) {
            contentHtml += `
              <div style="margin-top: 12px; border-radius: 8px; overflow: hidden;">
                <img src="${item.imageUrl}" style="width: 100%; height: auto; border-radius: 8px;" alt="${item.title}">
              </div>
            `;
          }
          
          contentHtml += `
              <div class="tag-container" style="margin-top: 8px;">
          `;
          
          item.tags.forEach(tag => {
            const color = this.getTagColor(tag);
            contentHtml += `
              <ion-badge class="category-badge" color="${color}" onclick="event.stopPropagation(); app.handleTagClick('${tag}')">
                ${tag}
              </ion-badge>
            `;
          });
          
          contentHtml += `
              </div>
            </ion-label>
          `;
          
          colContent.innerHTML = contentHtml;
          row.appendChild(colContent);
          grid.appendChild(row);
          ionItem.appendChild(grid);

          this.eventManager.on(ionItem, 'click', () => {
            this.showItemDetail(item);
          });

          return ionItem;
        }

        extractVideoId(url) {
          if (!url) return null;
          
          const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
          const match = url.match(regExp);
          return (match && match[2].length === 11) ? match[2] : null;
        }

        openVideoModal(itemId) {
          const item = this.dataManager.items.find(item => item.id == itemId);
          if (!item || !item.videoUrl) return;
          
          const videoId = this.extractVideoId(item.videoUrl);
          if (!videoId) {
            this.showToast('無法解析視頻URL', 'danger');
            return;
          }
          
          document.getElementById('video-modal-title').textContent = item.title;
          document.getElementById('video-player').src = `https://www.youtube.com/embed/${videoId}`;
          document.getElementById('video-description').textContent = item.description;
          
          const modal = document.querySelector('ion-modal#video-modal');
          if (modal) {
            modal.present();
          }
        }

        closeVideoModal() {
          const modal = document.querySelector('ion-modal#video-modal');
          if (modal) {
            const videoPlayer = document.getElementById('video-player');
            if (videoPlayer) {
              videoPlayer.src = '';
            }
            modal.dismiss();
          }
        }

        async showItemDetail(item) {
          const actionSheet = DOMManager.create('ion-action-sheet');
          actionSheet.header = item.title;
          actionSheet.subHeader = item.subtitle;
          
          const buttons = [];
          
          if (item.videoUrl && item.videoUrl.trim() !== '') {
            buttons.push({
              text: '播放視頻',
              icon: 'play',
              handler: () => this.openVideoModal(item.id)
            });
          }
          
          buttons.push({
            text: item.favorite ? '取消收藏' : '加入收藏',
            icon: item.favorite ? 'star-outline' : 'star',
            handler: () => this.toggleFavorite(item.id)
          });
          
          buttons.push({
            text: '分享主題',
            icon: 'share', 
            handler: () => this.shareItem(item)
          });
          
          buttons.push({
            text: '取消',
            icon: 'close',
            role: 'cancel'
          });
          
          actionSheet.buttons = buttons;

          document.body.appendChild(actionSheet);
          await actionSheet.present();
        }

        async toggleFavorite(itemId) {
          try {
            const wasFavorite = await this.dataManager.toggleFavorite(itemId, this.authService);
            this.render();
            this.updateStatistics();
          } catch (error) {
            console.error('切換收藏失敗:', error);
          }
        }

        handleTagClick(tag) {
          const searchbar = DOMManager.query('#main-searchbar');
          if (searchbar) {
            searchbar.value = tag;
          }
          this.handleSearch(tag);
          this.showToast(`已篩選標籤: ${tag}`);
        }

        showEmptyState() {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          list.innerHTML = `
            <div class="empty-state">
              <ion-icon name="search-outline"></ion-icon>
              <h3>沒有找到相關內容</h3>
              <p>請嘗試其他搜索條件或重新加載數據</p>
              <ion-button fill="solid" color="primary" onclick="app.reloadWikiEntries()">
                <ion-icon name="refresh" slot="start"></ion-icon>重新加載API數據
              </ion-button>
            </div>
          `;
        }

        updateFilterStatus() {
          const statusElement = DOMManager.query('#filter-status');
          if (!statusElement) return;
          
          const filters = this.dataManager.filters;
          let statusText = '';

          if (filters.search) {
            statusText += `搜索: "${filters.search}" `;
          }
          if (filters.category !== 'all') {
            statusText += `分類: ${filters.category} `;
          }
          if (filters.favorites) {
            statusText += '僅收藏 ';
          }
          if (filters.videos) {
            statusText += '僅視頻 ';
          }

          if (statusText) {
            statusElement.style.display = 'block';
            statusElement.innerHTML = `
              <ion-item>
                <ion-label>篩選條件: ${statusText}</ion-label>
                <ion-button fill="clear" size="small" onclick="app.clearAllFilters()">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-item>
            `;
          } else {
            statusElement.style.display = 'none';
          }
        }

        updateStatistics() {
          const stats = this.dataManager.getStatistics();
          
          const elements = [
            { id: 'total-count', value: stats.total },
            { id: 'video-count', value: stats.videos },
            { id: 'favorite-count', value: stats.favorites },
            { id: 'category-count', value: stats.categories },
            { id: 'count-all', value: stats.categoryCounts.all },
            { id: 'count-education', value: stats.categoryCounts.education },
            { id: 'count-community', value: stats.categoryCounts.community },
            { id: 'count-tools', value: stats.categoryCounts.tools },
            { id: 'count-favorites', value: stats.categoryCounts.favorites },
            { id: 'count-videos', value: stats.categoryCounts.videos }
          ];

          elements.forEach(({ id, value }) => {
            const element = DOMManager.query(`#${id}`);
            if (element) {
              element.textContent = value.toString();
            }
          });
        }

        clearAllFilters() {
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          
          if (searchbar) searchbar.value = '';
          if (segment) segment.value = 'all';
          
          this.dataManager.updateFilters({
            search: '',
            category: 'all', 
            favorites: false,
            videos: false
          });
          this.render();
          
          const statusElement = DOMManager.query('#filter-status');
          if (statusElement) {
            statusElement.style.display = 'none';
          }
        }

        showLoading(show) {
          this.dataManager.showLoading(show);
        }

        scrollToTop() {
          const content = DOMManager.query('ion-content');
          if (content) {
            content.scrollToTop(500);
          }
        }

        closeAllModals() {
          const modals = DOMManager.queryAll('ion-modal');
          modals.forEach(modal => {
            if (modal.dismiss) {
              modal.dismiss();
            }
          });
        }

        showSortOptions() {
          this.showToast('排序選項功能', 'primary');
        }

        async shareItem(item) {
          if (navigator.share) {
            try {
              await navigator.share({
                title: item.title,
                text: item.details,
                url: window.location.href
              });
            } catch (error) {
              this.showToast('分享已取消', 'medium');
            }
          } else {
            this.showToast('分享功能不可用', 'warning');
          }
        }

        toggleTheme(isDark) {
          this.currentTheme = isDark ? 'dark' : 'light';
          document.body.classList.toggle('ion-palette-dark', isDark);
          this.showToast(`已切換到${isDark ? '深色' : '淺色'}主題`);
        }

        getTagColor(tag) {
          const colorMap = {
            '教育': 'success', '詞典': 'success', '學習': 'success',
            '社群': 'danger', '組織': 'danger', '管理': 'danger', 
            '政策': 'warning', '結構': 'warning', '版本': 'warning',
            '媒體': 'tertiary', '資料': 'tertiary', '網站': 'tertiary',
            '百科': 'primary', '文獻': 'primary', '引用': 'primary',
            '工具': 'dark', '條目': 'secondary',
            '生物多樣性': 'success', '地球生態系統': 'success',
            '世界建築史': 'tertiary', '建築風格': 'tertiary',
            '太空探索史': 'primary', '科學': 'primary'
          };
          return colorMap[tag] || 'primary';
        }

        async showToast(message, color = 'primary') {
          try {
            const toast = DOMManager.create('ion-toast', {
              properties: {
                message,
                duration: 2000,
                color,
                position: 'bottom'
              }
            });
            document.body.appendChild(toast);
            await toast.present();
          } catch (error) {
            console.warn('顯示 Toast 失敗:', error);
          }
        }

        render() {
          const filteredItems = this.dataManager.filterItems();
          this.renderFilteredItems(filteredItems);
          this.updateStatistics();
          this.updateFilterStatus();
          
          if (this.dataManager.items.length > 0) {
            DOMManager.toggleVisibility('#load-more-tip', this.dataManager.hasMore);
            DOMManager.toggleVisibility('#load-complete-tip', !this.dataManager.hasMore);
          }
        }

        destroy() {
          this.eventManager.destroy();
        }
      }

      let app;

      document.addEventListener('DOMContentLoaded', async () => {
        app = new IonicThemeListApp();
        await app.initializeApp();
      });

      window.addEventListener('beforeunload', () => {
        if (app) {
          app.destroy();
        }
      });
    </script>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸»é¡Œæ¸…å–®</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <style>
      /* ä½¿ç”¨ Ionic CSS è®Šæ•¸ */
      :root {
        --custom-primary: #3880ff;
        --custom-primary-light: #e8f2ff;
        --custom-success: #2dd36f;
        --custom-warning: #ffc409;
        --custom-danger: #eb445a;
        --custom-medium: #92949c;
      }

      /* è‡ªå®šç¾©å¡ç‰‡æ¨£å¼ */
      .custom-card {
        --background: white;
        --border-radius: 12px;
        margin: 8px;
        border: 1px solid var(--ion-color-light-shade);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .custom-card:active {
        transform: scale(0.98);
        background: var(--custom-primary-light);
      }

      .search-header {
        --background: var(--custom-primary);
      }

      .category-badge {
        margin: 2px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .category-badge:active {
        transform: scale(0.95);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--custom-medium);
      }

      .empty-state ion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--custom-primary);
        opacity: 0.7;
      }

      .filter-status {
        background: linear-gradient(135deg, var(--custom-primary-light), white);
        border-bottom: 2px solid var(--custom-primary);
      }

      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: flex-end;
      }

      .favorite-icon {
        color: var(--custom-warning);
        margin-right: 8px;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        .desktop-only {
          display: none;
        }
        
        .tag-container {
          justify-content: flex-start;
          margin-top: 0.5rem;
        }
        
        .mobile-full-width {
          width: 100%;
        }
      }

      @media (min-width: 992px) {
        .custom-card {
          margin: 8px 16px;
        }
        
        .custom-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          border-color: var(--custom-primary);
        }
      }

      /* å‹•ç•«æ•ˆæœ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      /* è¼‰å…¥ç‹€æ…‹ */
      .skeleton-loader {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* éŒ¯èª¤ç‹€æ…‹ */
      .error-state {
        text-align: center;
        padding: 2rem;
        color: var(--custom-danger);
      }

      /* åˆå§‹åŒ–è¼‰å…¥ç‹€æ…‹ */
      .init-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <!-- åˆå§‹åŒ–è¼‰å…¥ç‹€æ…‹ -->
      <div id="init-loading" class="init-loading">
        <ion-spinner name="crescent" style="width: 40px; height: 40px;"></ion-spinner>
        <p style="margin-top: 16px; color: var(--custom-medium);">æ‡‰ç”¨ç¨‹å¼è¼‰å…¥ä¸­...</p>
      </div>

      <!-- ä¸»é é¢å…§å®¹ (åˆå§‹éš±è—) -->
      <div id="main-content" style="display: none;">
        <ion-header class="search-header">
          <ion-toolbar>
            <ion-title>ç¶­åŸºä¸»é¡Œæ¸…å–®</ion-title>
            
            <ion-buttons slot="end">
              <ion-button id="theme-toggle" fill="clear">
                <ion-icon slot="icon-only" name="contrast"></ion-icon>
              </ion-button>
              <ion-button id="info-button" fill="clear">
                <ion-icon slot="icon-only" name="information-circle"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>

          <!-- æœç´¢å€åŸŸ -->
          <ion-toolbar>
            <ion-searchbar 
              placeholder="æœå°‹ä¸»é¡Œ..."
              animated="true"
              debounce="300"
              id="main-searchbar">
            </ion-searchbar>
          </ion-toolbar>

          <!-- åˆ†é¡ç¯©é¸ -->
          <ion-toolbar>
            <ion-segment value="all" id="category-segment">
              <ion-segment-button value="all">
                <ion-label>å…¨éƒ¨</ion-label>
              </ion-segment-button>
              <ion-segment-button value="education">
                <ion-label>æ•™è‚²</ion-label>
              </ion-segment-button>
              <ion-segment-button value="community">
                <ion-label>ç¤¾ç¾¤</ion-label>
              </ion-segment-button>
              <ion-segment-button value="tools">
                <ion-label>å·¥å…·</ion-label>
              </ion-segment-button>
              <ion-segment-button value="favorites">
                <ion-label>æ”¶è—</ion-label>
              </ion-segment-button>
            </ion-segment>
          </ion-toolbar>
        </ion-header>

        <ion-content fullscreen="true">
          <!-- ç¯©é¸ç‹€æ…‹é¡¯ç¤º -->
          <div id="filter-status" class="filter-status" style="display: none;"></div>

          <!-- éŸ¿æ‡‰å¼ä½ˆå±€ -->
          <ion-grid fixed>
            <ion-row>
              <!-- æ¡Œé¢ç«¯å´é‚Šæ¬„ -->
              <ion-col size="12" size-md="3" class="desktop-only">
                <ion-list class="slide-in">
                  <ion-list-header>
                    <ion-label>å¿«é€Ÿç¯©é¸</ion-label>
                    <ion-button fill="clear" size="small" id="clear-filters">
                      <ion-icon name="refresh" slot="icon-only"></ion-icon>
                    </ion-button>
                  </ion-list-header>
                  
                  <ion-item button id="filter-all" color="primary">
                    <ion-icon name="apps" slot="start"></ion-icon>
                    <ion-label>å…¨éƒ¨ä¸»é¡Œ</ion-label>
                    <ion-badge slot="end" color="primary" id="count-all">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-education">
                    <ion-icon name="school" slot="start"></ion-icon>
                    <ion-label>æ•™è‚²å­¸ç¿’</ion-label>
                    <ion-badge slot="end" color="success" id="count-education">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-community">
                    <ion-icon name="people" slot="start"></ion-icon>
                    <ion-label>ç¤¾ç¾¤ç®¡ç†</ion-label>
                    <ion-badge slot="end" color="danger" id="count-community">0</ion-badge>
                  </ion-item>
                  
                  <ion-item button id="filter-tools">
                    <ion-icon name="construct" slot="start"></ion-icon>
                    <ion-label>å·¥å…·è³‡æº</ion-label>
                    <ion-badge slot="end" color="warning" id="count-tools">0</ion-badge>
                  </ion-item>

                  <ion-item button id="filter-favorites">
                    <ion-icon name="star" slot="start"></ion-icon>
                    <ion-label>æˆ‘çš„æ”¶è—</ion-label>
                    <ion-badge slot="end" color="warning" id="count-favorites">0</ion-badge>
                  </ion-item>
                </ion-list>

                <!-- çµ±è¨ˆè³‡è¨Š -->
                <ion-list class="slide-in" style="margin-top: 1rem;">
                  <ion-list-header>
                    <ion-label>çµ±è¨ˆè³‡è¨Š</ion-label>
                  </ion-list-header>
                  <ion-item>
                    <ion-label>ç¸½ä¸»é¡Œæ•¸</ion-label>
                    <ion-note slot="end" id="total-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>æ”¶è—æ•¸</ion-label>
                    <ion-note slot="end" id="favorite-count">0</ion-note>
                  </ion-item>
                  <ion-item>
                    <ion-label>åˆ†é¡æ•¸</ion-label>
                    <ion-note slot="end" id="category-count">0</ion-note>
                  </ion-item>
                </ion-list>
              </ion-col>

              <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
              <ion-col size="12" size-md="9">
                <!-- ä¸‹æ‹‰åˆ·æ–° -->
                <ion-refresher slot="fixed" id="content-refresher">
                  <ion-refresher-content
                    pulling-icon="lines"
                    refreshing-spinner="crescent">
                  </ion-refresher-content>
                </ion-refresher>

                <!-- è¼‰å…¥ç‹€æ…‹ -->
                <div id="loading-state" style="display: none;">
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                  <div class="skeleton-loader" style="height: 80px; margin: 8px; border-radius: 12px;"></div>
                </div>

                <!-- ä¸»é¡Œåˆ—è¡¨ -->
                <ion-list lines="full" id="theme-list">
                  <!-- åˆ—è¡¨å…§å®¹ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </ion-list>

                <!-- ç„¡é™æ»¾å‹• -->
                <ion-infinite-scroll id="infinite-scroll">
                  <ion-infinite-scroll-content
                    loading-spinner="bubbles"
                    loading-text="è¼‰å…¥æ›´å¤šä¸»é¡Œ...">
                  </ion-infinite-scroll-content>
                </ion-infinite-scroll>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-content>

        <!-- æµ®å‹•æ“ä½œæŒ‰éˆ• -->
        <ion-fab vertical="bottom" horizontal="end" slot="fixed">
          <ion-fab-button id="main-fab">
            <ion-icon name="ellipsis-vertical"></ion-icon>
          </ion-fab-button>
          <ion-fab-list side="top">
            <ion-fab-button color="secondary" id="fab-signup" data-action="signup">
              <ion-icon name="person-add"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="tertiary" id="fab-login" data-action="login">
              <ion-icon name="log-in"></ion-icon>
            </ion-fab-button>
            <ion-fab-button color="danger" id="fab-logout" data-action="logout" style="display: none;">
              <ion-icon name="log-out"></ion-icon>
            </ion-fab-button>
          </ion-fab-list>
        </ion-fab>

        <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
        <ion-modal trigger="theme-toggle" id="settings-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>æ‡‰ç”¨ç¨‹å¼è¨­å®š</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-list-header>
                <ion-label>å¤–è§€è¨­å®š</ion-label>
              </ion-list-header>
              
              <ion-item>
                <ion-toggle id="dark-mode-toggle">
                  <ion-label>æš—é»‘æ¨¡å¼</ion-label>
                </ion-toggle>
              </ion-item>
              
              <ion-item>
                <ion-select label="ä¸»é¡Œè‰²å½©" id="theme-color-select">
                  <ion-select-option value="blue">è—è‰²ä¸»é¡Œ</ion-select-option>
                  <ion-select-option value="green">ç¶ è‰²ä¸»é¡Œ</ion-select-option>
                  <ion-select-option value="purple">ç´«è‰²ä¸»é¡Œ</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <!-- è³‡è¨Šæ¨¡æ…‹æ¡† -->
        <ion-modal trigger="info-button" id="info-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>é—œæ–¼æ‡‰ç”¨ç¨‹å¼</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-info-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-icon name="logo-ionic" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <h3>ç¶­åŸºä¸»é¡Œæ¸…å–®</h3>
                  <p>ç‰ˆæœ¬ 1.0.0</p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label class="ion-text-wrap">
                  <h4>åŠŸèƒ½ç‰¹è‰²</h4>
                  <p>â€¢ ä¸»é¡Œæœç´¢èˆ‡ç¯©é¸</p>
                  <p>â€¢ åˆ†é¡ç®¡ç†</p>
                  <p>â€¢ æ”¶è—åŠŸèƒ½</p>
                  <p>â€¢ éŸ¿æ‡‰å¼è¨­è¨ˆ</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-content>
        </ion-modal>

        <!-- è¨»å†Šæ¨¡æ…‹æ¡† -->
        <ion-modal id="signup-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>ç”¨æˆ¶è¨»å†Š</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-signup-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">ç”¨æˆ¶å</ion-label>
                <ion-input type="text" id="signup-username" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">å¯†ç¢¼</ion-label>
                <ion-input type="password" id="signup-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-signup" style="margin-top: 20px;">
              è¨»å†Š
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>å·²æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="switch-to-login">ç«‹å³ç™»å…¥</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>

        <!-- ç™»å…¥æ¨¡æ…‹æ¡† -->
        <ion-modal id="login-modal">
          <ion-header>
            <ion-toolbar>
              <ion-title>ç”¨æˆ¶ç™»å…¥</ion-title>
              <ion-buttons slot="end">
                <ion-button id="close-login-modal">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-list>
              <ion-item>
                <ion-label position="stacked">ç”¨æˆ¶å</ion-label>
                <ion-input type="text" id="login-username" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="stacked">å¯†ç¢¼</ion-label>
                <ion-input type="password" id="login-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></ion-input>
              </ion-item>
            </ion-list>
            
            <ion-button expand="block" color="primary" id="submit-login" style="margin-top: 20px;">
              ç™»å…¥
            </ion-button>
            
            <div style="text-align: center; margin-top: 16px;">
              <ion-text color="medium">
                <small>é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="switch-to-signup">ç«‹å³è¨»å†Š</a></small>
              </ion-text>
            </div>
          </ion-content>
        </ion-modal>
      </div>

    <script>
      /**
       * äº‹ä»¶ç®¡ç†å™¨ - çµ±ä¸€ç®¡ç†æ‰€æœ‰äº‹ä»¶è™•ç†
       */
      class EventManager {
        constructor() {
          this.handlers = new Map();
          this.debounceTimers = new Map();
        }

        /**
         * è¨»å†Šäº‹ä»¶ç›£è½å™¨
         */
        on(element, event, handler, options = {}) {
          if (!element) {
            console.warn('ç„¡æ³•è¨»å†Šäº‹ä»¶: å…ƒç´ ç‚º null', event);
            return () => {};
          }
          
          if (!this.handlers.has(element)) {
            this.handlers.set(element, new Map());
          }
          
          const wrappedHandler = this.wrapHandler(handler, options);
          element.addEventListener(event, wrappedHandler, options);
          this.handlers.get(element).set(event, wrappedHandler);
          
          return () => this.off(element, event);
        }

        /**
         * ç§»é™¤äº‹ä»¶ç›£è½å™¨
         */
        off(element, event) {
          if (this.handlers.has(element)) {
            const handlers = this.handlers.get(element);
            if (handlers.has(event)) {
              element.removeEventListener(event, handlers.get(event));
              handlers.delete(event);
            }
          }
        }

        /**
         * åŒ…è£è™•ç†å™¨ï¼ˆæ”¯æŒé˜²æŠ–ã€ç¯€æµï¼‰
         */
        wrapHandler(handler, options) {
          let wrappedHandler = handler;

          if (options.debounce) {
            wrappedHandler = this.debounce(handler, options.debounce);
          }

          if (options.throttle) {
            wrappedHandler = this.throttle(handler, options.throttle);
          }

          return wrappedHandler;
        }

        /**
         * é˜²æŠ–å‡½æ•¸
         */
        debounce(func, wait) {
          return (...args) => {
            const key = func.toString();
            clearTimeout(this.debounceTimers.get(key));
            this.debounceTimers.set(key, setTimeout(() => func(...args), wait));
          };
        }

        /**
         * ç¯€æµå‡½æ•¸
         */
        throttle(func, limit) {
          let inThrottle;
          return (...args) => {
            if (!inThrottle) {
              func.apply(this, args);
              inThrottle = true;
              setTimeout(() => inThrottle = false, limit);
            }
          };
        }

        /**
         * ä¸€æ¬¡æ€§äº‹ä»¶
         */
        once(element, event, handler) {
          return this.on(element, event, handler, { once: true });
        }

        /**
         * æ¸…ç†æ‰€æœ‰äº‹ä»¶
         */
        destroy() {
          for (const [element, events] of this.handlers) {
            for (const [event, handler] of events) {
              element.removeEventListener(event, handler);
            }
          }
          this.handlers.clear();
          this.debounceTimers.clear();
        }
      }

      /**
       * DOM æ“ä½œç®¡ç†å™¨
       */
      class DOMManager {
        /**
         * å®‰å…¨æŸ¥è©¢å…ƒç´ 
         */
        static query(selector, parent = document) {
          try {
            const element = parent.querySelector(selector);
            return element;
          } catch (error) {
            console.warn('DOM Query Error:', error.message);
            return null;
          }
        }

        /**
         * å®‰å…¨æŸ¥è©¢å¤šå€‹å…ƒç´ 
         */
        static queryAll(selector, parent = document) {
          try {
            return Array.from(parent.querySelectorAll(selector));
          } catch (error) {
            console.warn('DOM QueryAll Error:', error.message);
            return [];
          }
        }

        /**
         * å‰µå»ºå…ƒç´ 
         */
        static create(tag, options = {}) {
          const element = document.createElement(tag);
          
          if (options.classes) {
            element.className = options.classes;
          }
          
          if (options.attributes) {
            Object.entries(options.attributes).forEach(([key, value]) => {
              element.setAttribute(key, value);
            });
          }
          
          if (options.properties) {
            Object.entries(options.properties).forEach(([key, value]) => {
              element[key] = value;
            });
          }
          
          if (options.html) {
            element.innerHTML = options.html;
          } else if (options.text) {
            element.textContent = options.text;
          }
          
          if (options.children) {
            options.children.forEach(child => {
              if (child instanceof Node) {
                element.appendChild(child);
              }
            });
          }
          
          return element;
        }

        /**
         * é¡¯ç¤º/éš±è—å…ƒç´ 
         */
        static toggleVisibility(selector, show) {
          const element = this.query(selector);
          if (element) {
            element.style.display = show ? '' : 'none';
          }
        }
      }

      /**
       * è³‡æ–™ç®¡ç†å™¨
       */
      class DataManager {
        constructor() {
          this.items = [];
          this.filters = {
            search: '',
            category: 'all',
            favorites: false
          };
          this.currentPage = 1;
          this.hasMore = true;
          this.isLoading = false;
          this.totalPages = 1;
          this.toastHandler = null;
        }

        /**
         * è¨­ç½® Toast è™•ç†å™¨
         */
        setToastHandler(handler) {
          this.toastHandler = handler;
        }

        /**
         * é¡¯ç¤º Toast
         */
        showToast(message, color = 'primary') {
          if (this.toastHandler) {
            this.toastHandler(message, color);
          }
        }

        /**
         * é¡¯ç¤º/éš±è—è¼‰å…¥ç‹€æ…‹
         */
        showLoading(show) {
          const loadingElement = document.getElementById('loading-state');
          const listElement = document.getElementById('theme-list');
          const infiniteScroll = document.getElementById('infinite-scroll');
          
          if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
          }
          if (listElement) {
            listElement.style.display = show ? 'none' : 'block';
          }
          if (infiniteScroll) {
            infiniteScroll.disabled = show;
          }
        }

        /**
         * åˆå§‹åŒ–è³‡æ–™
         */
        async initializeData() {
          try {
            console.log('ğŸ” æ¸¬è©¦APIé€£ç·š...');
            
            this.showLoading(true);
            
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/wiki-entries?page=1&limit=10');

            if (response.ok) {
              const data = await response.json();
              console.log('âœ… APIé€£ç·šæˆåŠŸï¼Œæ”¶åˆ°è³‡æ–™:', data);
              
              this.items = data.items.map(item => ({
                id: item.id,
                title: item.title,
                subtitle: item.category,
                details: item.description,
                tags: item.tags || ['APIè³‡æ–™'],
                category: this.mapCategory(item.category),
                favorite: false,
                apiData: true
              }));
              
              this.totalPages = data.pagination.total_pages || 1;
              this.currentPage = 1;
              this.hasMore = this.currentPage < this.totalPages;
              
              this.showToast('è³‡æ–™è¼‰å…¥æˆåŠŸ', 'success');
            } else {
              console.warn('âŒ APIé€£ç·šå¤±æ•—ï¼Œç‹€æ…‹ç¢¼:', response.status);
              let errorMessage = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`;
              try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                // å¿½ç•¥ JSON è§£æéŒ¯èª¤
              }
              this.showToast(`è³‡æ–™è¼‰å…¥å¤±æ•—: ${errorMessage}ï¼Œä½¿ç”¨æœ¬åœ°ç¯„ä¾‹è³‡æ–™`, 'warning');
              this.useFallbackData();
            }
            
            return this.items;
          } catch (error) {
            console.error('ğŸ’¥ APIéŒ¯èª¤:', error);
            this.showToast('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç¯„ä¾‹è³‡æ–™', 'warning');
            this.useFallbackData();
            return this.items;
          } finally {
            this.showLoading(false);
          }
        }

        /**
         * è¼‰å…¥æ›´å¤šè³‡æ–™
         */
        async loadMoreData() {
          if (this.isLoading || !this.hasMore) {
            return [];
          }

          try {
            this.isLoading = true;
            this.currentPage++;
            
            console.log(`ğŸ“– è¼‰å…¥ç¬¬ ${this.currentPage} é è³‡æ–™...`);
            
            const response = await fetch(`https://dae-mobile-assignment.hkit.cc/api/wiki-entries?page=${this.currentPage}&limit=10`);

            if (response.ok) {
              const data = await response.json();
              console.log('âœ… è¼‰å…¥æ›´å¤šè³‡æ–™æˆåŠŸ:', data);
              
              const newItems = data.items.map(item => ({
                id: item.id,
                title: item.title,
                subtitle: item.category,
                details: item.description,
                tags: item.tags || ['APIè³‡æ–™'],
                category: this.mapCategory(item.category),
                favorite: false,
                apiData: true
              }));
              
              this.items = [...this.items, ...newItems];
              this.hasMore = this.currentPage < (data.pagination.total_pages || 1);
              
              if (newItems.length > 0) {
                this.showToast(`å·²è¼‰å…¥ ${newItems.length} å€‹æ–°ä¸»é¡Œ`, 'success');
              } else {
                this.showToast('å·²è¼‰å…¥æ‰€æœ‰ä¸»é¡Œ', 'medium');
              }
              
              return newItems;
            } else {
              console.warn('âŒ è¼‰å…¥æ›´å¤šè³‡æ–™å¤±æ•—:', response.status);
              this.currentPage--; // å›é€€é ç¢¼
              this.showToast('è¼‰å…¥æ›´å¤šè³‡æ–™å¤±æ•—', 'warning');
              return [];
            }
          } catch (error) {
            console.error('ğŸ’¥ è¼‰å…¥æ›´å¤šè³‡æ–™éŒ¯èª¤:', error);
            this.currentPage--; // å›é€€é ç¢¼
            this.showToast('è¼‰å…¥æ›´å¤šè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
            return [];
          } finally {
            this.isLoading = false;
          }
        }

        /**
         * æ˜ å°„åˆ†é¡
         */
        mapCategory(category) {
          const categoryMap = {
            'education': 'education',
            'community': 'community', 
            'tools': 'tools',
            'technology': 'tools',
            'science': 'education',
            'culture': 'community'
          };
          return categoryMap[category] || 'education';
        }

        /**
         * ä½¿ç”¨å‚™ç”¨è³‡æ–™
         */
        useFallbackData() {
          this.items = [
            { 
              id: 1, 
              title: 'Wikipedia', 
              subtitle: 'è‡ªç”±çš„ç¶²è·¯ç™¾ç§‘å…¨æ›¸', 
              details: 'ç”±å…¨çƒå¿—é¡˜è€…å”ä½œæ’°å¯«çš„å¤šèªè¨€ç™¾ç§‘å…¨æ›¸ï¼ŒåŒ…å«è¶…éæ•¸ç™¾è¬ç¯‡æ¢ç›®ï¼Œæ¶µè“‹å„å€‹é ˜åŸŸçš„çŸ¥è­˜ã€‚', 
              tags: ['ç™¾ç§‘å…¨æ›¸', 'çŸ¥è­˜', 'å”ä½œ'], 
              category: 'education', 
              favorite: false,
              apiData: false
            },
            { 
              id: 2, 
              title: 'Wikimedia Foundation', 
              subtitle: 'éç‡Ÿåˆ©çµ„ç¹”', 
              details: 'æ”¯æ´ç¶­åŸºç™¾ç§‘èˆ‡å…¶ä»–ç¶­åŸºå°ˆæ¡ˆçš„åŸºé‡‘æœƒï¼Œè‡´åŠ›æ–¼è®“çŸ¥è­˜è‡ªç”±åˆ†äº«çµ¦å…¨ä¸–ç•Œã€‚', 
              tags: ['çµ„ç¹”', 'éç‡Ÿåˆ©', 'åŸºé‡‘æœƒ'], 
              category: 'community', 
              favorite: true,
              apiData: false
            },
            { 
              id: 3, 
              title: 'MediaWiki', 
              subtitle: 'ç¶­åŸºè»Ÿé«”', 
              details: 'ç¶­åŸºç™¾ç§‘ä½¿ç”¨çš„é–‹æºç¶­åŸºè»Ÿé«”ï¼Œæ”¯æ´å¤šäººå”ä½œç·¨è¼¯å’Œå…§å®¹ç®¡ç†ã€‚', 
              tags: ['è»Ÿé«”', 'é–‹æº', 'ç·¨è¼¯'], 
              category: 'tools', 
              favorite: false,
              apiData: false
            },
            { 
              id: 4, 
              title: 'Wikidata', 
              subtitle: 'çµæ§‹åŒ–è³‡æ–™åº«', 
              details: 'è‡ªç”±çš„çµæ§‹åŒ–çŸ¥è­˜åº«ï¼Œç‚ºç¶­åŸºåª’é«”é …ç›®æä¾›æ©Ÿå™¨å¯è®€çš„è³‡æ–™ã€‚', 
              tags: ['è³‡æ–™åº«', 'çµæ§‹åŒ–', 'çŸ¥è­˜'], 
              category: 'tools', 
              favorite: false,
              apiData: false
            },
            { 
              id: 5, 
              title: 'Wiktionary', 
              subtitle: 'ç·šä¸Šè©å…¸', 
              details: 'è‡ªç”±çš„å¤šèªè¨€è©å…¸å’Œè©åº«ï¼ŒåŒ…å«è©èªå®šç¾©ã€ç™¼éŸ³å’Œç”¨æ³•ç¤ºä¾‹ã€‚', 
              tags: ['è©å…¸', 'èªè¨€', 'å­¸ç¿’'], 
              category: 'education', 
              favorite: true,
              apiData: false
            }
          ];
          this.hasMore = false;
          console.log('ğŸ“š ä½¿ç”¨æœ¬åœ°ç¯„ä¾‹è³‡æ–™ï¼Œå…±', this.items.length, 'å€‹é …ç›®');
        }

        /**
         * éæ¿¾è³‡æ–™
         */
        filterItems() {
          return this.items.filter(item => {
            const matchesSearch = !this.filters.search || 
              item.title.toLowerCase().includes(this.filters.search) ||
              item.subtitle.toLowerCase().includes(this.filters.search) ||
              item.details.toLowerCase().includes(this.filters.search) ||
              item.tags.some(tag => tag.toLowerCase().includes(this.filters.search));
            
            const matchesCategory = this.filters.category === 'all' || 
              item.category === this.filters.category;
            
            const matchesFavorites = !this.filters.favorites || item.favorite;
            
            return matchesSearch && matchesCategory && matchesFavorites;
          });
        }

        /**
         * æ›´æ–°ç¯©é¸æ¢ä»¶
         */
        updateFilters(newFilters) {
          this.filters = { ...this.filters, ...newFilters };
          return this.filterItems();
        }

        /**
         * åˆ‡æ›æ”¶è—ç‹€æ…‹
         */
        async toggleFavorite(itemId, authService) {
          const item = this.items.find(item => item.id === itemId);
          if (!item) return false;

          const newFavoriteState = !item.favorite;
          
          // å¦‚æœç”¨æˆ¶å·²ç™»å…¥ä¸”æ˜¯ API è³‡æ–™ï¼Œå‰‡åŒæ­¥åˆ°å¾Œç«¯
          if (authService.isLoggedIn() && item.apiData) {
            try {
              const response = await fetch(`https://dae-mobile-assignment.hkit.cc/api/wiki-entries/${itemId}/favorite`, {
                method: newFavoriteState ? 'POST' : 'DELETE',
                headers: {
                  'Authorization': `Bearer ${authService.token}`,
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                item.favorite = newFavoriteState;
                this.showToast(newFavoriteState ? 'å·²åŠ å…¥æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—', 'success');
                return newFavoriteState;
              } else {
                throw new Error('API è«‹æ±‚å¤±æ•—');
              }
            } catch (error) {
              console.error('æ”¶è—æ“ä½œå¤±æ•—:', error);
              this.showToast('æ”¶è—æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'warning');
              return item.favorite; // è¿”å›åŸç‹€æ…‹
            }
          } else {
            // æœ¬åœ°æ“ä½œæˆ–æœªç™»å…¥ç”¨æˆ¶
            item.favorite = newFavoriteState;
            if (authService.isLoggedIn()) {
              this.showToast(newFavoriteState ? 'å·²åŠ å…¥æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—', 'success');
            } else {
              this.showToast(newFavoriteState ? 'å·²åŠ å…¥æ”¶è—ï¼ˆæœ¬åœ°ï¼‰' : 'å·²å–æ¶ˆæ”¶è—ï¼ˆæœ¬åœ°ï¼‰', 'medium');
            }
            return newFavoriteState;
          }
        }

        /**
         * è¼‰å…¥ç”¨æˆ¶æ”¶è—ç‹€æ…‹
         */
        async loadUserFavorites(authService) {
          if (!authService.isLoggedIn()) return;

          try {
            const response = await fetch('https://dae-mobile-assignment.hkit.cc/api/user/favorites', {
              headers: {
                'Authorization': `Bearer ${authService.token}`
              }
            });

            if (response.ok) {
              const favorites = await response.json();
              const favoriteIds = new Set(favorites.map(fav => fav.wiki_entry_id));
              
              // æ›´æ–°æœ¬åœ°æ”¶è—ç‹€æ…‹
              this.items.forEach(item => {
                if (favoriteIds.has(item.id)) {
                  item.favorite = true;
                }
              });
              
              console.log('âœ… å·²åŒæ­¥ç”¨æˆ¶æ”¶è—ç‹€æ…‹');
            }
          } catch (error) {
            console.warn('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶æ”¶è—:', error);
          }
        }

        /**
         * ç²å–çµ±è¨ˆè³‡æ–™
         */
        getStatistics() {
          const total = this.items.length;
          const favorites = this.items.filter(item => item.favorite).length;
          const categories = new Set(this.items.map(item => item.category)).size;
          
          const categoryCounts = {
            all: total,
            education: this.items.filter(item => item.category === 'education').length,
            community: this.items.filter(item => item.category === 'community').length,
            tools: this.items.filter(item => item.category === 'tools').length,
            favorites: favorites
          };

          return { total, favorites, categories, categoryCounts };
        }
      }

      /**
       * èªè­‰æœå‹™
       */
      class AuthService {
        constructor() {
          this.baseURL = 'https://dae-mobile-assignment.hkit.cc/api';
          this.token = localStorage.getItem('auth_token');
          this.userId = localStorage.getItem('user_id');
        }

        /**
         * ç”¨æˆ¶è¨»å†Š
         */
        async signup(username, password) {
          try {
            console.log('ğŸ” é–‹å§‹è¨»å†Š...');
            
            const response = await fetch(`${this.baseURL}/auth/signup`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `è¨»å†Šå¤±æ•—: ${response.status}`);
            }

            const data = await response.json();
            console.log('âœ… è¨»å†ŠæˆåŠŸ:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('âŒ è¨»å†ŠéŒ¯èª¤:', error);
            throw error;
          }
        }

        /**
         * ç”¨æˆ¶ç™»å…¥
         */
        async login(username, password) {
          try {
            console.log('ğŸ” é–‹å§‹ç™»å…¥...');
            
            const response = await fetch(`${this.baseURL}/auth/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username: username,
                password: password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || `ç™»å…¥å¤±æ•—: ${response.status}`);
            }

            const data = await response.json();
            console.log('âœ… ç™»å…¥æˆåŠŸ:', data);
            
            this.saveAuthData(data.token, data.user_id);
            
            return data;
          } catch (error) {
            console.error('âŒ ç™»å…¥éŒ¯èª¤:', error);
            throw error;
          }
        }

        /**
         * ç”¨æˆ¶ç™»å‡º
         */
        logout() {
          this.token = null;
          this.userId = null;
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_id');
          console.log('ğŸšª ç”¨æˆ¶å·²ç™»å‡º');
        }

        /**
         * ä¿å­˜èªè­‰è³‡æ–™
         */
        saveAuthData(token, userId) {
          this.token = token;
          this.userId = userId;
          localStorage.setItem('auth_token', token);
          localStorage.setItem('user_id', userId);
          console.log('ğŸ’¾ èªè­‰è³‡æ–™å·²ä¿å­˜');
        }

        /**
         * æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
         */
        isLoggedIn() {
          return !!this.token;
        }

        /**
         * ç²å–èªè­‰æ¨™é ­
         */
        getAuthHeaders() {
          return {
            'Authorization': `Bearer ${this.token}`
          };
        }
      }

      /**
       * Ionic ä¸»é¡Œæ¸…å–®æ‡‰ç”¨ç¨‹å¼
       */
      class IonicThemeListApp {
        constructor() {
          this.eventManager = new EventManager();
          this.dataManager = new DataManager();
          this.authService = new AuthService();
          this.currentTheme = 'light';
          this.isLoading = false;
          this.isInitialized = false;
        }

        /**
         * åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
         */
        async initializeApp() {
          try {
            console.log('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
            
            DOMManager.toggleVisibility('#init-loading', true);
            DOMManager.toggleVisibility('#main-content', false);

            await this.waitForIonicComponents();
            
            // è¨­ç½® DataManager çš„ toast è™•ç†å™¨
            this.dataManager.setToastHandler((message, color) => this.showToast(message, color));
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            this.updateLoginState(this.authService.isLoggedIn());
            
            await this.dataManager.initializeData();
            
            // å¦‚æœç”¨æˆ¶å·²ç™»å…¥ï¼Œè¼‰å…¥æ”¶è—ç‹€æ…‹
            if (this.authService.isLoggedIn()) {
              await this.dataManager.loadUserFavorites(this.authService);
            }
            
            this.setupEventListeners();

            this.render();
            
            DOMManager.toggleVisibility('#init-loading', false);
            DOMManager.toggleVisibility('#main-content', true);
            
            this.isInitialized = true;
            console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
            
          } catch (error) {
            console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
            this.showErrorState('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—: ' + error.message);
          }
        }

        /**
         * ç­‰å¾… Ionic å…ƒä»¶è¨»å†Šå®Œæˆ
         */
        async waitForIonicComponents() {
          const components = [
            'ion-segment',
            'ion-searchbar', 
            'ion-refresher',
            'ion-infinite-scroll',
            'ion-list',
            'ion-modal',
            'ion-toast',
            'ion-action-sheet',
            'ion-loading'
          ];

          const promises = components.map(component => 
            customElements.whenDefined(component)
          );

          await Promise.all(promises);
          console.log('æ‰€æœ‰ Ionic å…ƒä»¶å·²è¨»å†Šå®Œæˆ');
          
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        /**
         * è¨­ç½®äº‹ä»¶ç›£è½å™¨
         */
        setupEventListeners() {
          // å®‰å…¨çš„å…ƒç´ æŸ¥è©¢
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          const refresher = DOMManager.query('#content-refresher');
          const infiniteScroll = DOMManager.query('#infinite-scroll');

          if (searchbar) {
            this.eventManager.on(
              searchbar,
              'ionInput',
              (ev) => this.handleSearch(ev.detail.value),
              { debounce: 300 }
            );
          }

          if (segment) {
            this.eventManager.on(
              segment,
              'ionChange',
              (ev) => this.handleCategoryChange(ev.detail.value)
            );
          }

          if (refresher) {
            this.eventManager.on(
              refresher,
              'ionRefresh',
              (ev) => this.handleRefresh(ev)
            );
          }

          if (infiniteScroll) {
            this.eventManager.on(
              infiniteScroll,
              'ionInfinite',
              (ev) => this.handleInfiniteScroll(ev)
            );
          }

          // è¨»å†Šç›¸é—œäº‹ä»¶
          const signupButton = DOMManager.query('#submit-signup');
          if (signupButton) {
            this.eventManager.on(
              signupButton,
              'click',
              () => this.handleSignup()
            );
          }

          const closeSignupModal = DOMManager.query('#close-signup-modal');
          if (closeSignupModal) {
            this.eventManager.on(
              closeSignupModal,
              'click',
              () => this.closeSignupModal()
            );
          }

          const switchToLogin = DOMManager.query('#switch-to-login');
          if (switchToLogin) {
            this.eventManager.on(
              switchToLogin,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToLogin();
              }
            );
          }

          // ç™»å…¥ç›¸é—œäº‹ä»¶
          const loginButton = DOMManager.query('#submit-login');
          if (loginButton) {
            this.eventManager.on(
              loginButton,
              'click',
              () => this.handleLogin()
            );
          }

          const closeLoginModal = DOMManager.query('#close-login-modal');
          if (closeLoginModal) {
            this.eventManager.on(
              closeLoginModal,
              'click',
              () => this.closeLoginModal()
            );
          }

          const switchToSignup = DOMManager.query('#switch-to-signup');
          if (switchToSignup) {
            this.eventManager.on(
              switchToSignup,
              'click',
              (e) => {
                e.preventDefault();
                this.switchToSignup();
              }
            );
          }

          // å¿«é€Ÿç¯©é¸äº‹ä»¶
          ['all', 'education', 'community', 'tools', 'favorites'].forEach(category => {
            const element = DOMManager.query(`#filter-${category}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleQuickFilter(category)
              );
            }
          });

          // FAB å‹•ä½œäº‹ä»¶
          ['signup', 'login', 'logout'].forEach(action => {
            const element = DOMManager.query(`#fab-${action}`);
            if (element) {
              this.eventManager.on(
                element,
                'click',
                () => this.handleFabAction(action)
              );
            }
          });

          // æ¸…é™¤ç¯©é¸äº‹ä»¶
          const clearFilters = DOMManager.query('#clear-filters');
          if (clearFilters) {
            this.eventManager.on(
              clearFilters,
              'click',
              () => this.clearAllFilters()
            );
          }

          // éµç›¤äº‹ä»¶
          this.eventManager.on(
            document,
            'keydown',
            (ev) => this.handleKeyboard(ev)
          );
        }

        /**
         * è™•ç†æœç´¢
         */
        handleSearch(searchTerm) {
          if (!this.isInitialized) return;
          
          const filteredItems = this.dataManager.updateFilters({ 
            search: searchTerm.toLowerCase() 
          });
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        /**
         * è™•ç†åˆ†é¡è®ŠåŒ–
         */
        handleCategoryChange(category) {
          if (!this.isInitialized) return;
          
          const isFavorites = category === 'favorites';
          const filteredItems = this.dataManager.updateFilters({
            category: isFavorites ? 'all' : category,
            favorites: isFavorites
          });
          this.renderFilteredItems(filteredItems);
          this.updateFilterStatus();
        }

        /**
         * è™•ç†å¿«é€Ÿç¯©é¸
         */
        handleQuickFilter(category) {
          const segment = DOMManager.query('#category-segment');
          if (segment) {
            segment.value = category;
          }
          this.handleCategoryChange(category);
        }

        /**
         * è™•ç†ä¸‹æ‹‰åˆ·æ–°
         */
        async handleRefresh(event) {
          this.dataManager.showLoading(true);
          
          try {
            await this.dataManager.initializeData();
            this.render();
            this.showToast('é‡æ–°æ•´ç†å®Œæˆ', 'success');
          } catch (error) {
            this.showToast('é‡æ–°æ•´ç†å¤±æ•—', 'danger');
          } finally {
            this.dataManager.showLoading(false);
            if (event && event.target) {
              event.target.complete();
            }
          }
        }

        /**
         * è™•ç†ç„¡é™æ»¾å‹•
         */
        async handleInfiniteScroll(event) {
          try {
            const newItems = await this.dataManager.loadMoreData();
            if (newItems.length > 0) {
              this.renderFilteredItems(this.dataManager.filterItems());
            }
          } catch (error) {
            console.error('ç„¡é™æ»¾å‹•éŒ¯èª¤:', error);
            this.showToast('è¼‰å…¥æ›´å¤šè³‡æ–™å¤±æ•—', 'danger');
          } finally {
            if (event && event.target) {
              event.target.complete();
              
              // å¦‚æœæ²’æœ‰æ›´å¤šè³‡æ–™ï¼Œç¦ç”¨ç„¡é™æ»¾å‹•
              if (!this.dataManager.hasMore) {
                event.target.disabled = true;
              }
            }
          }
        }

        /**
         * è™•ç† FAB å‹•ä½œ
         */
        handleFabAction(action) {
          const actions = {
            signup: () => this.openSignupModal(),
            login: () => this.openLoginModal(),
            logout: () => this.handleLogout(),
            create: () => this.showToast('å‰µå»ºæ–°ä¸»é¡ŒåŠŸèƒ½', 'primary'),
            filter: () => this.showToast('é€²éšç¯©é¸åŠŸèƒ½', 'primary'),
            sort: () => this.showSortOptions(),
            scrollTop: () => this.scrollToTop()
          };
          
          if (actions[action]) {
            actions[action]();
          } else {
            console.warn('æœªå®šç¾©çš„ FAB å‹•ä½œ:', action);
          }
        }

        /**
         * æ‰“é–‹è¨»å†Šæ¨¡æ…‹æ¡†
         */
        openSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * é—œé–‰è¨»å†Šæ¨¡æ…‹æ¡†
         */
        closeSignupModal() {
          const modal = document.querySelector('ion-modal#signup-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        /**
         * è™•ç†ç”¨æˆ¶è¨»å†Š
         */
        async handleSignup() {
          try {
            console.log('ğŸŸ¡ é–‹å§‹è™•ç†è¨»å†Š...');
            
            const username = DOMManager.query('#signup-username').value;
            const password = DOMManager.query('#signup-password').value;
            
            console.log('ğŸ“ è¼¸å…¥çš„ç”¨æˆ¶å:', username);
            console.log('ğŸ“ è¼¸å…¥çš„å¯†ç¢¼:', password);

            if (!username || !password) {
              this.showToast('è«‹å¡«å¯«ç”¨æˆ¶åå’Œå¯†ç¢¼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('ç”¨æˆ¶åè‡³å°‘éœ€è¦3å€‹å­—ç¬¦', 'warning');
              return;
            }

            if (password.length < 6) {
              this.showToast('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            await this.authService.signup(username, password);
            
            this.showToast('è¨»å†ŠæˆåŠŸï¼', 'success');
            this.closeSignupModal();
            
            DOMManager.query('#signup-username').value = '';
            DOMManager.query('#signup-password').value = '';

            this.updateLoginState(true);

          } catch (error) {
            console.error('è¨»å†Šè™•ç†éŒ¯èª¤:', error);
            this.showToast(`è¨»å†Šå¤±æ•—: ${error.message}`, 'danger');
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        /**
         * è™•ç†ç”¨æˆ¶ç™»å…¥
         */
        async handleLogin() {
          try {
            console.log('ğŸŸ¡ é–‹å§‹è™•ç†ç™»å…¥...');
            
            const usernameInput = DOMManager.query('#login-username');
            const passwordInput = DOMManager.query('#login-password');
            
            if (!usernameInput || !passwordInput) {
              this.showToast('ç™»å…¥è¡¨å–®å…ƒç´ æœªæ‰¾åˆ°', 'danger');
              return;
            }
            
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            console.log('ğŸ“ è¼¸å…¥çš„ç”¨æˆ¶å:', username);
            console.log('ğŸ“ è¼¸å…¥çš„å¯†ç¢¼:', password);

            if (!username || !password) {
              this.showToast('è«‹å¡«å¯«ç”¨æˆ¶åå’Œå¯†ç¢¼', 'warning');
              return;
            }

            if (username.length < 3) {
              this.showToast('ç”¨æˆ¶åè‡³å°‘éœ€è¦3å€‹å­—ç¬¦', 'warning');
              return;
            }

            this.dataManager.showLoading(true);

            const result = await this.authService.login(username, password);
            
            // è¼‰å…¥ç”¨æˆ¶æ”¶è—ç‹€æ…‹
            await this.dataManager.loadUserFavorites(this.authService);
            
            this.showToast('ç™»å…¥æˆåŠŸï¼', 'success');
            this.closeLoginModal();
            
            usernameInput.value = '';
            passwordInput.value = '';

            this.updateLoginState(true);
            this.render(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ”¶è—ç‹€æ…‹
            
            return result;

          } catch (error) {
            console.error('ç™»å…¥è™•ç†éŒ¯èª¤:', error);
            this.showToast(`ç™»å…¥å¤±æ•—: ${error.message}`, 'danger');
            throw error;
          } finally {
            this.dataManager.showLoading(false);
          }
        }

        /**
         * æ‰“é–‹ç™»å…¥æ¨¡æ…‹æ¡†
         */
        openLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.present();
          }
        }

        /**
         * é—œé–‰ç™»å…¥æ¨¡æ…‹æ¡†
         */
        closeLoginModal() {
          const modal = document.querySelector('ion-modal#login-modal');
          if (modal) {
            modal.dismiss();
          }
        }

        /**
         * è™•ç†ç”¨æˆ¶ç™»å‡º
         */
        handleLogout() {
          this.authService.logout();
          this.showToast('å·²ç™»å‡º', 'medium');
          this.updateLoginState(false);
          this.render(); // é‡æ–°æ¸²æŸ“ä»¥æ¸…é™¤æ”¶è—ç‹€æ…‹
        }

        /**
         * åˆ‡æ›åˆ°ç™»å…¥ç•Œé¢
         */
        switchToLogin() {
          this.closeSignupModal();
          this.openLoginModal();
        }

        /**
         * åˆ‡æ›åˆ°è¨»å†Šç•Œé¢
         */
        switchToSignup() {
          this.closeLoginModal();
          this.openSignupModal();
        }

        /**
         * æ›´æ–°ç™»å…¥ç‹€æ…‹ UI
         */
        updateLoginState(isLoggedIn) {
          const fabSignup = DOMManager.query('#fab-signup');
          const fabLogin = DOMManager.query('#fab-login');
          const fabLogout = DOMManager.query('#fab-logout');
          
          if (isLoggedIn) {
            if (fabSignup) fabSignup.style.display = 'none';
            if (fabLogin) fabLogin.style.display = 'none';
            if (fabLogout) fabLogout.style.display = 'block';
            console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥ï¼Œç”¨æˆ¶ID:', this.authService.userId);
          } else {
            if (fabSignup) fabSignup.style.display = 'block';
            if (fabLogin) fabLogin.style.display = 'block';
            if (fabLogout) fabLogout.style.display = 'none';
            console.log('ğŸšª ç”¨æˆ¶æœªç™»å…¥');
          }
        }

        /**
         * è™•ç†éµç›¤äº‹ä»¶
         */
        handleKeyboard(event) {
          if (!this.isInitialized) return;
          
          switch (event.key) {
            case 'Escape':
              this.closeAllModals();
              break;
            case '/':
              if (!event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                const searchbar = DOMManager.query('#main-searchbar');
                if (searchbar) {
                  searchbar.setFocus();
                }
              }
              break;
          }
        }

        /**
         * æ¸²æŸ“éæ¿¾å¾Œçš„é …ç›®
         */
        renderFilteredItems(filteredItems) {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          if (filteredItems.length === 0) {
            this.showEmptyState();
            return;
          }

          list.innerHTML = '';
          filteredItems.forEach(item => {
            const listItem = this.createListItem(item);
            list.appendChild(listItem);
          });
        }

        /**
         * å‰µå»ºåˆ—è¡¨é …ç›®
         */
        createListItem(item) {
          const ionItem = DOMManager.create('ion-item', {
            classes: 'custom-card fade-in',
            properties: {
              button: true,
              detail: true
            }
          });

          const grid = DOMManager.create('ion-grid');
          const row = DOMManager.create('ion-row');
          const colContent = DOMManager.create('ion-col', {
            attributes: {
              'size': '12',
              'size-md': '8'
            }
          });
          const colTags = DOMManager.create('ion-col', {
            attributes: {
              'size': '12', 
              'size-md': '4'
            }
          });

          const favoriteIcon = item.favorite ? 
            '<ion-icon name="star" class="favorite-icon"></ion-icon>' : '';
          
          colContent.innerHTML = `
            <ion-label>
              <h2 style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center;">
                ${favoriteIcon}${item.title}
              </h2>
              <p style="color: var(--ion-color-medium); margin-bottom: 8px;">${item.subtitle}</p>
              <p style="font-size: 0.9em; color: var(--ion-color-step-600); line-height: 1.4;">${item.details}</p>
            </ion-label>
          `;

          const tagsContainer = DOMManager.create('div', {
            classes: 'tag-container'
          });

          item.tags.forEach(tag => {
            const badge = DOMManager.create('ion-badge', {
              classes: 'category-badge',
              properties: {
                textContent: tag
              }
            });

            badge.color = this.getTagColor(tag);

            this.eventManager.on(badge, 'click', (e) => {
              e.stopPropagation();
              this.handleTagClick(tag);
            });

            tagsContainer.appendChild(badge);
          });

          colTags.appendChild(tagsContainer);

          row.appendChild(colContent);
          row.appendChild(colTags);
          grid.appendChild(row);
          ionItem.appendChild(grid);

          this.eventManager.on(ionItem, 'click', () => {
            this.showItemDetail(item);
          });

          return ionItem;
        }

        /**
         * é¡¯ç¤ºé …ç›®è©³æƒ…
         */
        async showItemDetail(item) {
          const actionSheet = DOMManager.create('ion-action-sheet');
          actionSheet.header = item.title;
          actionSheet.subHeader = item.subtitle;
          actionSheet.buttons = [
            {
              text: item.favorite ? 'å–æ¶ˆæ”¶è—' : 'åŠ å…¥æ”¶è—',
              icon: item.favorite ? 'star-outline' : 'star',
              handler: () => this.toggleFavorite(item.id)
            },
            {
              text: 'åˆ†äº«ä¸»é¡Œ',
              icon: 'share', 
              handler: () => this.shareItem(item)
            },
            {
              text: 'å–æ¶ˆ',
              icon: 'close',
              role: 'cancel'
            }
          ];

          document.body.appendChild(actionSheet);
          await actionSheet.present();
        }

        /**
         * åˆ‡æ›æ”¶è—ç‹€æ…‹
         */
        async toggleFavorite(itemId) {
          try {
            const wasFavorite = await this.dataManager.toggleFavorite(itemId, this.authService);
            this.render();
            this.updateStatistics();
          } catch (error) {
            console.error('åˆ‡æ›æ”¶è—å¤±æ•—:', error);
          }
        }

        /**
         * è™•ç†æ¨™ç±¤é»æ“Š
         */
        handleTagClick(tag) {
          const searchbar = DOMManager.query('#main-searchbar');
          if (searchbar) {
            searchbar.value = tag;
          }
          this.handleSearch(tag);
          this.showToast(`å·²ç¯©é¸æ¨™ç±¤: ${tag}`);
        }

        /**
         * é¡¯ç¤ºç©ºç‹€æ…‹
         */
        showEmptyState() {
          const list = DOMManager.query('#theme-list');
          if (!list) return;
          
          list.innerHTML = `
            <div class="empty-state">
              <ion-icon name="search-outline"></ion-icon>
              <h3>æ²’æœ‰æ‰¾åˆ°ç›¸é—œå…§å®¹</h3>
              <p>è«‹å˜—è©¦èª¿æ•´æœç´¢æ¢ä»¶æˆ–é¸æ“‡å…¶ä»–åˆ†é¡</p>
              <ion-button fill="clear" onclick="app.clearAllFilters()">
                é¡¯ç¤ºæ‰€æœ‰ä¸»é¡Œ
              </ion-button>
            </div>
          `;
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
         */
        showErrorState(message) {
          const initLoading = DOMManager.query('#init-loading');
          if (initLoading) {
            initLoading.innerHTML = `
              <div class="error-state">
                <ion-icon name="warning" style="font-size: 3rem;"></ion-icon>
                <h3>è¼‰å…¥å¤±æ•—</h3>
                <p>${message}</p>
                <ion-button onclick="location.reload()">
                  é‡æ–°è¼‰å…¥
                </ion-button>
              </div>
            `;
          }
        }

        /**
         * æ›´æ–°ç¯©é¸ç‹€æ…‹é¡¯ç¤º
         */
        updateFilterStatus() {
          const statusElement = DOMManager.query('#filter-status');
          if (!statusElement) return;
          
          const filters = this.dataManager.filters;
          let statusText = '';

          if (filters.search) {
            statusText += `æœç´¢: "${filters.search}" `;
          }
          if (filters.category !== 'all') {
            statusText += `åˆ†é¡: ${filters.category} `;
          }
          if (filters.favorites) {
            statusText += 'åƒ…æ”¶è— ';
          }

          if (statusText) {
            statusElement.style.display = 'block';
            statusElement.innerHTML = `
              <ion-item>
                <ion-label>ç¯©é¸æ¢ä»¶: ${statusText}</ion-label>
                <ion-button fill="clear" size="small" onclick="app.clearAllFilters()">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-item>
            `;
          } else {
            statusElement.style.display = 'none';
          }
        }

        /**
         * æ›´æ–°çµ±è¨ˆè³‡è¨Š
         */
        updateStatistics() {
          const stats = this.dataManager.getStatistics();
          
          const elements = [
            { id: 'total-count', value: stats.total },
            { id: 'favorite-count', value: stats.favorites },
            { id: 'category-count', value: stats.categories },
            { id: 'count-all', value: stats.categoryCounts.all },
            { id: 'count-education', value: stats.categoryCounts.education },
            { id: 'count-community', value: stats.categoryCounts.community },
            { id: 'count-tools', value: stats.categoryCounts.tools },
            { id: 'count-favorites', value: stats.categoryCounts.favorites }
          ];

          elements.forEach(({ id, value }) => {
            const element = DOMManager.query(`#${id}`);
            if (element) {
              element.textContent = value.toString();
            }
          });
        }

        /**
         * æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶
         */
        clearAllFilters() {
          const searchbar = DOMManager.query('#main-searchbar');
          const segment = DOMManager.query('#category-segment');
          
          if (searchbar) searchbar.value = '';
          if (segment) segment.value = 'all';
          
          this.dataManager.updateFilters({
            search: '',
            category: 'all', 
            favorites: false
          });
          this.render();
          
          const statusElement = DOMManager.query('#filter-status');
          if (statusElement) {
            statusElement.style.display = 'none';
          }
        }

        /**
         * é¡¯ç¤º/éš±è—è¼‰å…¥ç‹€æ…‹
         */
        showLoading(show) {
          this.dataManager.showLoading(show);
        }

        /**
         * æ»¾å‹•åˆ°é ‚éƒ¨
         */
        scrollToTop() {
          const content = DOMManager.query('ion-content');
          if (content) {
            content.scrollToTop(500);
          }
        }

        /**
         * é—œé–‰æ‰€æœ‰æ¨¡æ…‹æ¡†
         */
        closeAllModals() {
          const modals = DOMManager.queryAll('ion-modal');
          modals.forEach(modal => {
            if (modal.dismiss) {
              modal.dismiss();
            }
          });
        }

        /**
         * é¡¯ç¤ºæ’åºé¸é …
         */
        showSortOptions() {
          this.showToast('æ’åºé¸é …åŠŸèƒ½', 'primary');
        }

        /**
         * åˆ†äº«é …ç›®
         */
        async shareItem(item) {
          if (navigator.share) {
            try {
              await navigator.share({
                title: item.title,
                text: item.details,
                url: window.location.href
              });
            } catch (error) {
              this.showToast('åˆ†äº«å·²å–æ¶ˆ', 'medium');
            }
          } else {
            this.showToast('åˆ†äº«åŠŸèƒ½ä¸å¯ç”¨', 'warning');
          }
        }

        /**
         * åˆ‡æ›ä¸»é¡Œ
         */
        toggleTheme(isDark) {
          this.currentTheme = isDark ? 'dark' : 'light';
          document.body.classList.toggle('ion-palette-dark', isDark);
          this.showToast(`å·²åˆ‡æ›åˆ°${isDark ? 'æ·±è‰²' : 'æ·ºè‰²'}ä¸»é¡Œ`);
        }

        /**
         * ç²å–æ¨™ç±¤é¡è‰²
         */
        getTagColor(tag) {
          const colorMap = {
            'æ•™è‚²': 'success', 'è©å…¸': 'success', 'å­¸ç¿’': 'success',
            'ç¤¾ç¾¤': 'danger', 'çµ„ç¹”': 'danger', 'ç®¡ç†': 'danger', 
            'æ”¿ç­–': 'warning', 'çµæ§‹': 'warning', 'ç‰ˆæœ¬': 'warning',
            'åª’é«”': 'tertiary', 'è³‡æ–™': 'tertiary', 'ç¶²ç«™': 'tertiary',
            'ç™¾ç§‘': 'primary', 'æ–‡ç»': 'primary', 'å¼•ç”¨': 'primary',
            'å·¥å…·': 'dark', 'æ¢ç›®': 'secondary'
          };
          return colorMap[tag] || 'primary';
        }

        /**
         * é¡¯ç¤º Ionic åå¸
         */
        async showToast(message, color = 'primary') {
          try {
            const toast = DOMManager.create('ion-toast', {
              properties: {
                message,
                duration: 2000,
                color,
                position: 'bottom'
              }
            });
            document.body.appendChild(toast);
            await toast.present();
          } catch (error) {
            console.warn('é¡¯ç¤º Toast å¤±æ•—:', error);
          }
        }

        /**
         * ä¸»æ¸²æŸ“å‡½æ•¸
         */
        render() {
          const filteredItems = this.dataManager.filterItems();
          this.renderFilteredItems(filteredItems);
          this.updateStatistics();
          this.updateFilterStatus();
        }

        /**
         * éŠ·æ¯€æ‡‰ç”¨ç¨‹å¼
         */
        destroy() {
          this.eventManager.destroy();
        }
      }

      // å…¨å±€æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹
      let app;

      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      document.addEventListener('DOMContentLoaded', async () => {
        app = new IonicThemeListApp();
        await app.initializeApp();
      });

      // é é¢å¸è¼‰æ™‚æ¸…ç†
      window.addEventListener('beforeunload', () => {
        if (app) {
          app.destroy();
        }
      });
    </script>
  </body>
</html>